{% extends "cedepe/base.html" %}

{% block title %}Criar Aviso{% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>


    /* Seus estilos CSS permanecem os mesmos */
    .badge-wrap {
        white-space: normal;
        word-break: break-word;
        text-align: left;
        line-height: 1.4;
        max-width: 100%;
    }
    #carouselEscolasContainer .carousel {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        padding: 1rem 0;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .carousel-dark .carousel-control-prev-icon,
    .carousel-dark .carousel-control-next-icon {
        filter: invert(0.7) grayscale(100);
    }
    .carousel-dark .carousel-indicators [data-bs-target] {
        background-color: #555;
    }
    .carousel-item-content {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        padding: 0 4rem 2.5rem 4rem;
    }
    .modal-escolas-container {
        max-height: 250px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
    }

    /* --- Upload de Imagem Interativo --- */
    /* Estilo para os 'badges' (etiquetas) das escolas, permitindo quebra de linha */
    .badge-wrap {
        white-space: normal;
        word-break: break-word;
        text-align: left;
        line-height: 1.4;
        max-width: 100%;
    }

    /* Estilo para a nova área de upload de imagem (arraste e solte) */
    .file-drop-area {
        position: relative; /* Necessário para posicionar o input de arquivo invisível por cima */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 40px;
        border: 2px dashed #ccc;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: pointer;
        transition: border-color .15s ease-in-out, background-color .15s ease-in-out;
        text-align: center;
    }

    /* Efeito visual ao passar o mouse sobre a área de upload */
    .file-drop-area:hover {
        border-color: #0d6efd; /* Cor primária do Bootstrap */
        background-color: #e9f2ff;
    }

    /* Input de arquivo real, fica invisível mas funcional por cima da área */
    .file-drop-area input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0; /* Totalmente transparente */
        cursor: pointer;
    }

    /* Estilo do ícone de nuvem na área de upload */
    .file-drop-area .upload-icon {
        font-size: 3rem;
        color: #0d6efd;
    }
    
</style>

<div class="container-fluid bg-light-blue py-2 py-md-3">
    <div class="container">

        <!-- CABEÇALHO-->
        <div class="card-header py-3 d-flex flex-column flex-md-row justify-content-between align-items-center">
            <h3 class="mb-3 mb-md-0 ">
                <i class="bi bi-bell-fill me-2 "></i>
                Criar Novo Aviso
            </h3>
            <a href="{% url 'listar_avisos' %}" class="btn btn-outline-secondary d-inline-flex align-items-center rounded-3">
                <i class="fas fa-arrow-left me-2"></i>Ver lista de Avisos
            </a>
        </div>

        <!-- CRIAÇÃO DO AVISO -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">

                <!-- Seção para exibir mensagens do Django (ex: sucesso, erro) -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                
                <!-- Formulário principal -->
                <form method="post" id="avisoForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="row g-4">
                        <!-- Coluna da Esquerda: Detalhes do Aviso -->
                        <div class="col-lg-7">
                            <h6 class="text-muted fw-bold text-uppercase small mb-3">Detalhes do Aviso</h6>
                            <hr>
                            <div class="vstack gap-4">

                                <!-- Campo: Título do Aviso -->
                                <div>
                                    <label for="titulo" class="form-label fw-semibold">Título do Aviso</label>
                                    <input type="text" name="titulo" id="titulo" class="form-control" required value="{{ request.POST.titulo }}" placeholder="Ex: Reunião de Pais e Mestres">
                                </div>

                                <!-- Campo: Mensagem -->
                                <div class="col-md-12">
                                    <label for="mensagem" class="form-label fw-semibold">Mensagem</label>
                                    <textarea name="mensagem" id="mensagem" class="form-control" rows="4" required placeholder="Digite a mensagem completa do aviso aqui...">{{ request.POST.mensagem }}</textarea>
                                </div>

                                <div class="row g-3">
                                    <!-- Campo: Prioridade -->
                                    <div class="col-md-6">
                                        <label for="prioridade" class="form-label fw-semibold">Prioridade</label>
                                        <select name="prioridade" id="prioridade" class="form-select">
                                            <option value="baixa" {% if request.POST.prioridade == 'baixa' %}selected{% endif %}>Baixa</option>
                                            <option value="normal" {% if not request.POST.prioridade or request.POST.prioridade == 'normal' %}selected{% endif %}>Normal</option>
                                            <option value="alta" {% if request.POST.prioridade == 'alta' %}selected{% endif %}>Alta</option>
                                        </select>
                                    </div >
                                    <!-- Campo: Data e Hora de Expiração -->
                                    <div class="col-md-6">
                                        <label for="data_expiracao" class="form-label fw-semibold">Data e Hora de Expiração</label>
                                        <input type="datetime-local" name="data_expiracao" id="data_expiracao" class="form-control" required value="{{ request.POST.data_expiracao }}">
                                    </div>
                                </div>

                                <!-- Campo: Upload de Imagem -->
                                <div>
                                    <label for="imagem" class="form-label">Imagem do Aviso <span class="text-muted">(Opcional)</span></label>
                                    <!-- Área de Arraste e Solte -->
                                    <div class="file-drop-area">
                                        <span class="upload-icon"><i class="bi bi-cloud-arrow-up"></i></span>
                                        <p class="m-0"><strong>Clique para carregar</strong> ou arraste e solte</p>
                                        <small class="text-muted">PNG, JPG, GIF (MAX. 5MB)</small>
                                        <input type="file" name="imagem" id="imagem" class="form-control" accept="image/png, image/jpeg, image/gif">
                                        
                                        <!-- Preview da imagem selecionada (inicialmente oculto) -->
                                    <img id="imagePreview" src="#" alt="Preview da imagem selecionada" class="img-fluid rounded mt-2" style="max-height: 200px; display: none;"/> ''
                                    
                                    </div>
                                    
                                </div>
                            </div>
                        </div> 

                        <!-- Coluna da Direita: Destinatários -->
                        <div class="col-lg-5">
                            <h6 class="text-muted fw-bold text-uppercase small mb-3">Destinatários</h6>
                            <hr>

                                <label class="form-label fw-semibold">Selecione uma ou mais escolas para o aviso:</label>

                                <input type="text" id="termo_busca_checkbox" class="form-control mb-2" placeholder="Buscar escola por Nome ou INEP..." onkeyup="filtrarListaEscolas()">
                                
                                
                                <div id="listaEscolasCheckboxes" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                    {% if escolas %}
                                        {% for escola in escolas %}
                                        <div class="form-check escola-item" data-nome="{{ escola.nome|lower|escapejs }}" data-inep="{{ escola.inep|default_if_none:''|escapejs }}">
                                            <input class="form-check-input escola-checkbox" type="checkbox" name="escola_id" value="{{ escola.id }}" id="escola_check_{{ escola.id }}">
                                            <label class="form-check-label" for="escola_check_{{ escola.id }}">
                                                {{ escola.nome }} <span class="text-muted small">(INEP: {{ escola.inep|default_if_none:'N/A' }})</span>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted m-0 text-center">Nenhuma escola disponível para seleção.</p>
                                    {% endif %}
                                </div>
                                <div class="mt-3">
                                    <button type="button" id="btnMarcarTodasEscolasSistema" class="btn btn-outline-primary btn-sm me-2">
                                        <i class="bi bi-check2-square"></i> Marcar Todas
                                    </button>
                                    <button type="button" id="btnLimparSelecaoEscolas" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-x-square"></i> Limpar Seleção
                                    </button>
                                </div>
                                
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Escolas Selecionadas (<span id="contadorEscolas">0</span>):</label>
                                <div id="carouselEscolasContainer">
                                    </div>
                            </div>
                        </div>
                            
                        <div class="alert alert-warning d-flex align-items-center " role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="alert-heading">Atenção!</h6>
                                <ul class="mb-0 ps-3">
                                    <li>Verifique se todas as informações estão corretas antes de publicar.</li>
                                    <li>Uma vez publicado, o aviso só poderá ser <strong>editado ou apagado</strong>.</li>
                                    <li>Não é possível alterar as escolas de um aviso já enviado.</li>
                                </ul>
                            </div>
                        </div>
                        
                    </div>
                </form>
            </div>

            <div class="card-footer text-end bg-light p-3">
                <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#modalConfirmacao" id="btnPublicar" disabled>
                    <i class="bi bi-send-check-fill me-2"></i> Publicar Aviso
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmacaoLabel">Confirmar Publicação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>O aviso será enviado para <strong id="modalContadorEscolas">0 escolas</strong>. Confira a lista abaixo:</p>
                <div id="modalConfirmacaoEscolas"></div>
                <div class="alert alert-danger mt-3">
                    <strong>Atenção:</strong> Após confirmar, a ação não poderá ser desfeita. Você só poderá editar o conteúdo ou apagar o aviso completamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarPublicacao">
                    <i class="bi bi-check-circle me-2"></i>Confirmar e Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Todo o seu JavaScript existente...
// Adicionamos o listener para o preview da imagem.

// Função de busca 
function filtrarListaEscolas() {
    const termoBuscaInput = document.getElementById('termo_busca_checkbox');
    const termo = termoBuscaInput.value.toLowerCase().trim();
    document.querySelectorAll('.escola-item').forEach(item => {
        const nome = item.dataset.nome;
        const inep = item.dataset.inep;
        item.style.display = (nome.includes(termo) || (inep && inep.includes(termo))) ? '' : 'none';
    });
}

function atualizarDisplayEscolasSelecionadas() {
    const carouselContainer = document.getElementById('carouselEscolasContainer');
    const modalEscolasContainer = document.getElementById('modalConfirmacaoEscolas');
    const contadorEscolasSpan = document.getElementById('contadorEscolas');
    const modalContadorEscolasSpan = document.getElementById('modalContadorEscolas');
    carouselContainer.innerHTML = '';
    modalEscolasContainer.innerHTML = '';
    const checkedCheckboxes = Array.from(document.querySelectorAll('.escola-checkbox:checked'));
    const totalEscolasNoSistema = document.querySelectorAll('.escola-checkbox').length;
    const numSelecionadas = checkedCheckboxes.length;
    contadorEscolasSpan.textContent = numSelecionadas;
    modalContadorEscolasSpan.textContent = `${numSelecionadas} escola(s)`;
    if (numSelecionadas === 0) {
        carouselContainer.innerHTML = `<div class="p-3 border rounded bg-light text-muted text-center">Nenhuma escola selecionada.</div>`;
        modalEscolasContainer.innerHTML = `<div class="text-muted text-center">Nenhuma escola selecionada.</div>`;
    } else if (numSelecionadas === totalEscolasNoSistema) {
        const badgeTodas = `<div class="p-3 border rounded bg-light text-center"><span class="badge bg-primary fs-6 fw-normal badge-wrap">Todas as ${totalEscolasNoSistema} escolas do sistema selecionadas</span></div>`;
        carouselContainer.innerHTML = badgeTodas;
        modalEscolasContainer.innerHTML = badgeTodas;
    } else {
        const modalBadgesHtml = checkedCheckboxes.map(checkbox => {
            const escolaNome = checkbox.nextElementSibling.textContent.trim();
            return `<span class="badge text-bg-info badge-wrap m-1">${escolaNome}</span>`;
        }).join('');
        modalEscolasContainer.innerHTML = `<div class="modal-escolas-container d-flex flex-wrap justify-content-center">${modalBadgesHtml}</div>`;
        const escolasPorSlide = 8;
        const numSlides = Math.ceil(numSelecionadas / escolasPorSlide);
        const carouselId = 'escolasSelecionadasCarousel';
        let indicatorsHtml = '';
        let slidesHtml = '';
        for (let i = 0; i < numSlides; i++) {
            const activeClass = (i === 0) ? 'active' : '';
            indicatorsHtml += `<button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${i}" class="${activeClass}" aria-current="${activeClass ? 'true' : 'false'}"></button>`;
            const slideItems = checkedCheckboxes.slice(i * escolasPorSlide, (i + 1) * escolasPorSlide);
            const slideContent = slideItems.map(checkbox => {
                const escolaNome = checkbox.nextElementSibling.textContent.trim();
                return `<span class="badge text-bg-info badge-wrap">${escolaNome}</span>`;
            }).join('');
            slidesHtml += `
                <div class="carousel-item ${activeClass}">
                    <div class="carousel-item-content">${slideContent}</div>
                </div>`;
        }
        const controlsHtml = numSlides > 1 ? `
            <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Anterior</span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Próximo</span></button>
        ` : '';
        const indicatorsContainerHtml = numSlides > 1 ? `<div class="carousel-indicators">${indicatorsHtml}</div>` : '';
        carouselContainer.innerHTML = `
            <div id="${carouselId}" class="carousel carousel-dark slide" data-bs-ride="false">
                ${indicatorsContainerHtml}
                <div class="carousel-inner">${slidesHtml}</div>
                ${controlsHtml}
            </div>`;
    }
    const titulo = document.getElementById('titulo').value.trim();
    const mensagem = document.getElementById('mensagem').value.trim();
    document.getElementById('btnPublicar').disabled = !(titulo && mensagem && numSelecionadas > 0);
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('avisoForm');
    document.getElementById('titulo').addEventListener('input', atualizarDisplayEscolasSelecionadas);
    document.getElementById('mensagem').addEventListener('input', atualizarDisplayEscolasSelecionadas);
    document.querySelectorAll('.escola-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', atualizarDisplayEscolasSelecionadas);
    });
    document.getElementById('btnMarcarTodasEscolasSistema').addEventListener('click', () => {
        document.querySelectorAll('.escola-item').forEach(item => {
            if (item.style.display !== 'none') {
                item.querySelector('.escola-checkbox').checked = true;
            }
        });
        atualizarDisplayEscolasSelecionadas();
    });
    document.getElementById('btnLimparSelecaoEscolas').addEventListener('click', () => {
        document.querySelectorAll('.escola-checkbox:checked').forEach(c => { c.checked = false; });
        atualizarDisplayEscolasSelecionadas();
    });
    document.getElementById('confirmarPublicacao').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publicando...';
        form.submit();
    });

    // [NOVO] Listener para o preview da imagem
    const imageInput = document.getElementById('imagem');
    const imagePreview = document.getElementById('imagePreview');
    imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(this.files[0]);
        } else {
            imagePreview.style.display = 'none';
        }
    });

    atualizarDisplayEscolasSelecionadas();
});
</script>

{% endblock %}