{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}
Lacunas
{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="{% static 'css/tabelas.css' %}" />
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Lacunas (<span id="lacunas-count">{{ todas_lacunas }}</span>)</h3>

    <div class="col-12">
        <div class="d-flex justify-content-between gap-2 mb-3">
            
            <!--Barra de Pesquisa-->
            <div class="input-group" style="width: 50%;">
                <input type="text" id="search-input" class="form-control" name="q" value="{{ search_query }}" placeholder="Pesquise por Escola ou Disciplina...">
            </div>
            
            <div class="d-flex gap-2">
                <select class="form-select" id="date-filter" aria-label="Filtro Data">
                    <option value="">Data (Todas)</option>
                    <option value="7">Últimos 7 dias</option>
                    <option value="30">Últimos 30 dias</option>
                    <option value="365">Último ano</option>
                </select>
                <select class="form-select" id="status-filter" aria-label="Filtro Status">
                    <option value="">Status (Todos)</option>
                    <option value="P">Pendente</option>
                    <option value="E">Em Andamento</option>
                    <option value="R">Resolvido</option>
                </select>
            </div>

            <div class="d-flex gap-2">
                <button id="btn-update-status" class="btnAcao btn btn-info">Atualizar Status</button> 
                <button id="btn-delete-lacunas" class="btnAcao btn btn-danger">Apagar Lacunas</button> 
            </div>
        </div>


        <!--Tabela-->
        <div id="lacunas-table-wrapper">
            <table class="table table-striped mt-2">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox"></th>
                        <th class="text-start">Escola</th>
                        <th class="text-start">Disciplina</th>
                        <th class="text-start">Carga H.</th>
                        <th class="text-start">Data</th>
                        <th class="text-start">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lacuna in lacunas_page %}
                        <tr>
                            <td><input type="checkbox" class="lacuna-checkbox" name="lacuna_ids" value="{{ lacuna.id }}"></td>
                            <td class="text-start">{{ lacuna.escola.nome }}</td>
                            <td class="text-start">{{ lacuna.disciplina }}</td>
                            <td class="text-start">{{ lacuna.carga_horaria }}</td>
                            <td class="text-start">{{ lacuna.criado_em|date:"d/m/Y" }}</td>
                            <td>
                                <select class="form-select" name="status" data-lacuna-id="{{ lacuna.id }}"
                                    {% if lacuna.status == 'P' %} style="background-color: #ffcccc !important;" {% endif %} 
                                    {% if lacuna.status == 'R' %} style="background-color: #ccffcc !important;" {% endif %} 
                                    {% if lacuna.status == 'E' %} style="background-color: #ffffcc !important;" {% endif %}>
                                    <option value="P" {% if lacuna.status == 'P' %} selected {% endif %}>Pendente</option>
                                    <option value="R" {% if lacuna.status == 'R' %} selected {% endif %}>Resolvido</option>
                                    <option value="E" {% if lacuna.status == 'E' %} selected {% endif %}>Em Andamento</option>
                                </select>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center p-4">Nenhuma lacuna encontrada.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if lacunas_page.paginator.num_pages > 1 %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if lacunas_page.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ lacunas_page.previous_page_number }}&q={{ search_query }}&date_filter={{ date_filter }}&status_filter={{ status_filter }}">Anterior</a></li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">Página {{ lacunas_page.number }} de {{ lacunas_page.paginator.num_pages }}</span></li>
                    {% if lacunas_page.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ lacunas_page.next_page_number }}&q={{ search_query }}&date_filter={{ date_filter }}&status_filter={{ status_filter }}">Próximo</a></li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- SEÇÃO DE FILTRAGEM DINÂMICA (FUNCIONAL) ---
    const searchInput = document.getElementById('search-input');
    const dateFilter = document.getElementById('date-filter');
    const statusFilter = document.getElementById('status-filter');
    const tableWrapper = document.getElementById('lacunas-table-wrapper');
    const lacunasCountSpan = document.getElementById('lacunas-count');

    const fetchAndReplace = async () => {
        const query = searchInput.value;
        const date = dateFilter.value;
        const status = statusFilter.value;

        const url = `{% url 'tela_lacuna_view' %}?q=${encodeURIComponent(query)}&date_filter=${date}&status_filter=${status}`;

        try {
            const response = await fetch(url);
            const textResponse = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(textResponse, 'text/html');

            const newTableWrapper = doc.querySelector('#lacunas-table-wrapper');
            const newCount = doc.querySelector('#lacunas-count');

            if (newTableWrapper) tableWrapper.innerHTML = newTableWrapper.innerHTML;
            if (newCount) lacunasCountSpan.textContent = newCount.textContent;

        } catch (error) {
            console.error('Erro ao buscar lacunas:', error);
        }
    };

    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(fetchAndReplace, 300);
    });

    dateFilter.addEventListener('change', fetchAndReplace);
    statusFilter.addEventListener('change', fetchAndReplace);

    // --- SEÇÃO DE AÇÕES EM MASSA (PREPARADA PARA O FUTURO, SEM FUNÇÃO) ---
    
    // O código para os botões 'btn-update-status' e 'btn-delete-lacunas' pode ser adicionado aqui.
    // Exemplo:
    // const updateBtn = document.getElementById('btn-update-status');
    // updateBtn.addEventListener('click', () => {
    //     alert('Função de atualizar status a ser implementada!');
    // });

    // A lógica para o checkbox "selecionar todos" é útil para o desenvolvedor futuro.
    // Usamos 'document.body.addEventListener' porque a tabela é recarregada.
    document.body.addEventListener('change', function(event) {
        if (event.target.id === 'select-all-checkbox') {
            const checkboxes = document.querySelectorAll('.lacuna-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }
    });
});
</script>

{% endblock %}