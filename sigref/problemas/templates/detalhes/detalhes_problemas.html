{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}Detalhes dos Problemas{% endblock %}

{% block extra_style %}
<style>
    /* Estilos para os cards de problema */
    .problema-card {
        background-color: #fff;
        border: 1px solid #eef2f7;
        border-left-width: 5px;
        border-radius: var(--border-radius-md);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .problema-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        cursor: pointer;
    }

    /* Cores das bordas baseadas no status */
    .problema-card[data-status="P"] { border-left-color: var(--red); }
    .problema-card[data-status="E"] { border-left-color: var(--orange); }
    .problema-card[data-status="R"] { border-left-color: var(--green); }

    .problema-card .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.4em 0.8em;
    }

    /* Estilo para o estado vazio (nenhum problema encontrado) */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background-color: #fff;
        border-radius: var(--border-radius-lg);
        border: 2px dashed #e0e0e0;
    }
    .empty-state .icon {
        font-size: 3rem;
        color: #ced4da;
    }
    .empty-state p {
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Estilos para a nova barra de pesquisa */
    .search-container .input-group {
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        transition: box-shadow 0.3s ease-in-out;
    }
    .search-container .input-group:focus-within {
        box-shadow: 0 6px 25px rgba(38, 50, 109, 0.1);
    }
    .search-container .form-control, 
    .search-container .input-group-text {
        border: none;
        background-color: #fff;
        height: 50px;
    }
    .search-container .form-control:focus {
        box-shadow: none;
    }
    .search-container .input-group-text {
        padding-left: 1.25rem;
        color: var(--text-muted);
    }

    /* Ajustes de responsividade */
    @media (max-width: 991.98px) {
        .problema-info-grid {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    @media (max-width: 575.98px) {
        .problema-info-grid {
            grid-template-columns: 1fr !important;
            gap: 0.5rem !important;
        }
        .problema-card .text-end {
            text-align: start !important;
            margin-top: 1rem;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="container my-4 my-md-5">

    <!-- ================================================================== -->
    <!--                      Cabeçalho e Filtros                           -->
    <!-- ================================================================== -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <h1 class="titulo-secao mb-0" style="border-color: var(--accent-color);">
            <i class="fas fa-tasks text-primary me-2"></i>Histórico de Problemas
        </h1>
        <a href="{% if escola %}{% url 'dashboard_escola' escola_id=escola.id %}{% else %}{% url 'dashboard_escola' escola_id=problemas.0.escola.id %}{% endif %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
        </a>
    </div>

    <!-- Barra de Pesquisa (NOVO LAYOUT) -->
    <div class="search-container mb-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar por usuário, setor ou descrição...">
        </div>
    </div>

    <!-- ================================================================== -->
    <!--                     Lista de Problemas (Cards)                     -->
    <!-- ================================================================== -->
    <div class="vstack gap-3" id="problemas-list">
        {% for problema in problemas %}
            <div class="problema-card p-3" 
                data-status="{{ problema.status }}" 
                data-search-text="{{ problema.usuario.user.username|lower }} {{ problema.setor.nome|default:''|lower }} {{ problema.descricao|lower }}"
                data-bs-toggle="modal" 
                data-bs-target="#modalDetalheProblema"
                data-problema-id="{{ problema.id }}"
                data-problema-descricao="{{ problema.descricao }}"
                data-problema-usuario="{{ problema.usuario.user.get_full_name|default:problema.usuario.user.username }}"
                data-problema-setor="{{ problema.setor.nome|default:'N/A' }}"
                data-problema-data="{{ problema.criado_em|date:'d/m/Y H:i' }}"
                data-problema-status="{{ problema.status }}"
                data-problema-anexo-url="{% if problema.anexo %}{{ problema.anexo.url }}{% endif %}">

                <div class="d-flex flex-wrap align-items-start">
                    <!-- Descrição -->
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <strong class="text-dark">Descrição:</strong>
                            <span class="text-muted fw-normal">{{ problema.descricao|truncatechars:120 }}</span>
                        </h6>
                    </div>
                    <!-- Anexo -->
                    <div class="flex-shrink-0 ms-md-3 mt-2 mt-md-0">
                        {% if problema.anexo %}
                            <a href="{{ problema.anexo.url }}" target="_blank" class="btn btn-sm btn-outline-info" onclick="event.stopPropagation();">
                                <i class="fas fa-paperclip"></i> Anexo
                            </a>
                        {% endif %}
                    </div>
                </div>

                <hr class="my-2">

                <!-- Detalhes Rápidos -->
                <div class="d-grid gap-3 problema-info-grid" style="grid-template-columns: repeat(4, 1fr); font-size: 0.85rem;">
                    <div class="text-muted"><i class="fas fa-user me-2 text-primary"></i><strong>Usuário:</strong> {{ problema.usuario.user.username }}</div>
                    <div class="text-muted"><i class="fas fa-sitemap me-2 text-primary"></i><strong>Setor:</strong> {{ problema.setor.nome|default:"N/A" }}</div>
                    <div class="text-muted"><i class="fas fa-calendar-alt me-2 text-primary"></i><strong>Data:</strong> {{ problema.criado_em|date:"d/m/Y H:i" }}</div>
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2 text-primary"></i><strong>Status:</strong>
                        {% if problema.status == 'R' %}<span class="badge rounded-pill status-badge bg-success">{{ problema.get_status_display }}</span>
                        {% elif problema.status == 'P' %}<span class="badge rounded-pill status-badge bg-danger">{{ problema.get_status_display }}</span>
                        {% elif problema.status == 'E' %}<span class="badge rounded-pill status-badge bg-warning text-dark">{{ problema.get_status_display }}</span>
                        {% else %}<span class="badge rounded-pill status-badge bg-secondary">{{ problema.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            {# Este bloco será mostrado pelo JavaScript se a lista estiver vazia #}
        {% endfor %}
    </div>

    <!-- Mensagem de Estado Vazio (controlada por JS) -->
    <div id="empty-state-message" class="empty-state d-none mt-4">
        <div class="icon"><i class="fas fa-search"></i></div>
        <h5 class="mt-3">Nenhum Problema Encontrado</h5>
        <p>Tente ajustar os filtros ou o termo de busca.</p>
    </div>

    <!-- ================================================================== -->
    <!--                          Paginação                                 -->
    <!-- ================================================================== -->
    {% if problemas.has_other_pages %}
    <nav aria-label="Paginação de problemas" class="mt-4 d-flex justify-content-center">
        <ul class="pagination">
            {% if problemas.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ problemas.previous_page_number }}">Anterior</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            
            {% for i in problemas.paginator.page_range %}
                {% if problemas.number == i %}
                    <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}
            
            {% if problemas.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ problemas.next_page_number }}">Próxima</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Próxima</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- ================================================================== -->
<!--                    Modal de Detalhes do Problema                   -->
<!-- ================================================================== -->
{# Inclua o modal que criamos na resposta anterior aqui, se ainda não o fez. #}
{# Ele será acionado pelos atributos data-* nos cards. #}

{% endblock %}


{% block extra_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const problemasList = document.getElementById('problemas-list');
    const allProblemas = problemasList.querySelectorAll('.problema-card');
    const emptyStateMessage = document.getElementById('empty-state-message');

    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        let visibleCount = 0;

        allProblemas.forEach(card => {
            const cardText = card.dataset.searchText;

            if (cardText.includes(searchTerm)) {
                card.classList.remove('d-none');
                visibleCount++;
            } else {
                card.classList.add('d-none');
            }
        });

        // Mostra ou esconde a mensagem de estado vazio
        if (visibleCount === 0) {
            emptyStateMessage.classList.remove('d-none');
        } else {
            emptyStateMessage.classList.add('d-none');
        }
    }

    // Adiciona o 'event listener' para o filtro
    searchInput.addEventListener('keyup', filterAndSearch);

    // Verifica o estado inicial (caso a lista original já seja vazia)
    if (allProblemas.length === 0) {
        emptyStateMessage.querySelector('p').textContent = 'Ótimo! Nenhum problema foi reportado ainda.';
        emptyStateMessage.querySelector('.icon').innerHTML = '<i class="fas fa-check-circle"></i>';
        emptyStateMessage.classList.remove('d-none');
    }
});
</script>
{% endblock %}
