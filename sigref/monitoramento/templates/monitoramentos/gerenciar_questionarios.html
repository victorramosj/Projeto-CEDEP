{% extends 'cedepe/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Gerenciar Questionários</h2>
  <table class="table table-hover mt-3">
    <thead>
      <tr>
        <th>#</th>
        <th>Título</th>
        <th>Descrição</th>
        <th>Data</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for q in questionarios %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ q.titulo }}</td>
        <td>{{ q.descricao|truncatechars:50 }}</td>
        <td>{{ q.data_criacao }}</td>
        <td>
          <a href="{% url 'gerenciar_perguntas' q.id %}" class="btn btn-sm btn-primary">
            Perguntas
          </a>
          <button class="btn btn-sm btn-secondary" onclick="abrirModalEscolas({{ q.id }})">
            Escolas
          </button>
          
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Nenhum questionário encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'criar-questionario' %}" class="btn btn-success">
    + Novo Questionário
  </a>
</div>
<!-- Modal: Selecionar Escolas -->
<div class="modal fade" id="modalEscolas" tabindex="-1" aria-labelledby="modalEscolasLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEscolasLabel">Selecionar Escolas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3 d-flex gap-2">
          <input type="text" class="form-control" id="inputBuscaEscola" placeholder="Buscar escola...">
          <button class="btn btn-outline-success" onclick="selecionarTodasEscolasVisiveis()">
            Selecionar Todas Visíveis
          </button>
        </div>
        <div id="listaEscolas" class="d-flex flex-wrap gap-2"></div>
        <div class="mt-3">
          <span id="contadorEscolasSelecionadas" class="badge bg-primary">0 selecionadas</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="salvarEscolasSelecionadas()">Salvar</button>
      </div>
    </div>
  </div>
</div>
{% block scripts %}
{{ block.super }}
<script>
let escolasSelecionadasModal = new Set();
let idQuestionarioAtual = null;

function abrirModalEscolas(questionarioId) {
  idQuestionarioAtual = questionarioId;
  escolasSelecionadasModal.clear();
  document.getElementById("inputBuscaEscola").value = "";
  document.getElementById("listaEscolas").innerHTML = "";
  document.getElementById("contadorEscolasSelecionadas").textContent = "0 selecionadas";
  fetch(`/api/questionario/${questionarioId}/escolas`)  // crie essa rota na view
    .then(res => res.json())
    .then(data => {
      data.forEach(escola => {
        const div = document.createElement("div");
        div.className = "escola-pill";
        div.textContent = escola.nome;
        div.dataset.id = escola.id;
        if (escola.selecionada) {
          div.classList.add("selected");
          escolasSelecionadasModal.add(String(escola.id));
        }
        div.onclick = () => toggleSelecaoEscola(div.dataset.id);
        document.getElementById("listaEscolas").appendChild(div);
      });
      atualizarContadorModal();
      new bootstrap.Modal(document.getElementById('modalEscolas')).show();
    });
}

function toggleSelecaoEscola(id) {
  const pill = document.querySelector(`.escola-pill[data-id="${id}"]`);
  if (escolasSelecionadasModal.has(id)) {
    escolasSelecionadasModal.delete(id);
    pill.classList.remove("selected");
  } else {
    escolasSelecionadasModal.add(id);
    pill.classList.add("selected");
  }
  atualizarContadorModal();
}

function selecionarTodasEscolasVisiveis() {
  document.querySelectorAll(".escola-pill:not(.d-none)").forEach(p => {
    escolasSelecionadasModal.add(p.dataset.id);
    p.classList.add("selected");
  });
  atualizarContadorModal();
}

function atualizarContadorModal() {
  document.getElementById("contadorEscolasSelecionadas").textContent =
    `${escolasSelecionadasModal.size} selecionada${escolasSelecionadasModal.size !== 1 ? 's' : ''}`;
}

document.getElementById("inputBuscaEscola").addEventListener("input", function () {
  const termo = this.value.toLowerCase();
  document.querySelectorAll(".escola-pill").forEach(pill => {
    const texto = pill.textContent.toLowerCase();
    pill.classList.toggle("d-none", !texto.includes(termo));
  });
});

function salvarEscolasSelecionadas() {
  fetch(`/api/questionario/${idQuestionarioAtual}/escolas`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
    body: JSON.stringify({ escolas: Array.from(escolasSelecionadasModal) })
  }).then(res => {
    if (res.ok) {
      Swal.fire("Sucesso", "Escolas salvas com sucesso", "success");
      bootstrap.Modal.getInstance(document.getElementById('modalEscolas')).hide();
    } else {
      Swal.fire("Erro", "Não foi possível salvar as escolas", "error");
    }
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";").map(c => c.trim());
    for (let cookie of cookies) {
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.split("=")[1]);
        break;
      }
    }
  }
  return cookieValue;
}
</script>


{% endblock %}
{% endblock %}