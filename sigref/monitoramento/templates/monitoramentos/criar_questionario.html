{% extends 'cedepe/base.html' %}
{% load static %}

{% block extra_style %}
{{ block.super }}
<style>
    .creation-flow {
        background: #f8f9fa;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        padding: 1rem;
    }
    .flow-step {
        display: none;
        padding: 2rem;
        border-bottom: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }
    .flow-step.active {
        display: block;
        background: white;
        border-color: #0d6efd;
    }
    .question-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 1rem;
        padding: 1.5rem;
    }
    .escola-pill {
        background: #e9ecef;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .escola-pill.selected {
        background: #0d6efd;
        color: white;
    }
    .selection-actions {
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
    }
    
    
    .selected-counter {
        background: #0d6efd;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9em;
    }
    .setor-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .setor-card.selected {
        border: 2px solid #0d6efd;
        background-color: #e9f1ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-1 mt-1">
    <div class="creation-flow">
        <!-- Passo 0: Seleção de Setor -->
        <div class="flow-step" data-step="0">
            <h3 class="mb-4"><i class="fas fa-sitemap me-2"></i>Selecione o Setor</h3>
            <div class="row" id="setores-container">
                {% for setor in setores_permitidos %}
                <div class="col-md-6">
                    <div class="setor-card {% if setor_selecionado and setor.id == setor_selecionado.id %}selected{% endif %}"
     data-id="{{ setor.id }}"
     onclick="selectSetor(this)">
                        <h5>{{ setor.nome }}</h5>
                        <div class="setor-hierarchy">
                            {{ setor.hierarquia_completa }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary btn-sm" onclick="history.back()">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </button>
                <button class="btn btn-primary btn-sm" onclick="nextStep()">
                    Próximo <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Passo 1: Detalhes do Questionário -->
        <div class="flow-step" data-step="1">
            <h3 class="mb-4"><i class="fas fa-file-alt me-2"></i>Novo Questionário</h3>
            <div class="mb-4">
                <label class="form-label">Título</label>
                <input type="text" class="form-control form-control-lg" id="titulo">
            </div>
            <div class="mb-4">
                <label class="form-label">Descrição</label>
                <textarea class="form-control" id="descricao" rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary btn-sm" onclick="prevStep()">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </button>
                <button class="btn btn-primary btn-sm" onclick="nextStep()">
                    Próximo <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Passo 2: Perguntas -->
<div class="flow-step" data-step="2">
    <h3 class="mb-4"><i class="fas fa-question-circle me-2"></i>Adicionar Perguntas</h3>
    <div id="perguntas-container">
        <div class="question-card">
            <div class="row g-3">
                <div class="col-6 col-md-2">
                    <input type="number" readonly class="form-control question-order" placeholder="Ordem" min="1" value="1">
                </div>
                <div class="col-12 col-md-8">
                    <input type="text" class="form-control question-text" placeholder="Texto da pergunta">
                </div>
                <div class="col-6 col-md-2">
                    <select class="form-select question-type">
                        <option value="SN">Sim/Não</option>
                        <option value="NU">Numérico</option>
                        <option value="TX">Texto</option>
                    </select>
                </div>
               
            </div>
        </div>
    </div>
    <button class="btn btn-outline-primary mb-3" onclick="addQuestion()">
        <i class="fas fa-plus me-2"></i>Nova Pergunta
    </button>
    <div class="d-flex flex-wrap justify-content-between">
        <button class="btn btn-secondary btn-sm" onclick="prevStep()">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </button>
        <button class="btn btn-primary btn-sm" onclick="nextStep()">
            Próximo <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</div>


       <!-- Passo 3: Escolas - Modificado -->
<div class="flow-step" data-step="3">
    <h3 class="mb-4"><i class="fas fa-school me-2"></i>Selecionar Escolas</h3>
    <div class="row g-2 mb-3">
        <!-- Barra de pesquisa -->
        <div class="col-12 col-md-6">
            <input type="text" class="form-control form-control-sm" 
                   id="search-escolas" placeholder="Pesquisar escolas...">
        </div>
        
        <!-- Botões de ação -->
        <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
            <button class="btn btn-outline-success btn-sm flex-grow-1" 
                    onclick="toggleAllVisible()">
                <i class="fas fa-check-double me-2"></i>Selecionar Todas
            </button>
            <span class="btn btn-sm btn-outline-info flex-grow-1" 
                  id="selected-counter">0 selecionadas</span>
        </div>
    </div>
    
    <div id="escolas-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2"></div>

    <!-- Paginação -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-secondary btn-sm flex-shrink-0" onclick="prevStep()">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </button>
    <div id="pagination-container" class="mx-2 flex-grow-1 text-center"></div>
    <button class="btn btn-primary btn-sm flex-shrink-0" onclick="nextStep()">
        Próximo <i class="fas fa-arrow-right ms-2"></i>
    </button>
</div>

</div>

        
        <!-- Adicione este novo passo após o passo 3 -->
<div class="flow-step" data-step="4">
  <h3 class="mb-4"><i class="fas fa-clipboard-check me-2"></i>Configurar Monitoramento</h3>
  
  <div class="mb-4">
      <label class="form-label">Data Limite</label>
      <input type="date" class="form-control" id="data-limite" required>
  </div>
  
  <div class="mb-4">
    <label class="form-label">Frequência de Envio</label>
    <select class="form-select" id="frequencia">
        <option value="D">Diário</option>
        <option value="S">Semanal</option>
        <option value="Q">Quinzenal</option>
        <option value="M">Mensal</option>
        <option value="6">Semestral</option>  <!-- Novo -->
        <option value="A">Anual</option>      <!-- Novo -->
    </select>
</div>
  
  <div class="d-flex justify-content-between">
      <button class="btn btn-secondary btn-sm" onclick="prevStep()">
          <i class="fas fa-arrow-left me-2"></i>Voltar
      </button>
      <button class="btn btn-success btn-sm" onclick="submitForm()">
          Finalizar <i class="fas fa-check ms-2"></i>
      </button>
  </div>
</div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
let currentStep = 0;
let selectedSetorId = {{ setor_selecionado.id|default:'null' }};
const escolasSelecionadas = new Set();

function showStep() {
  document.querySelectorAll('.flow-step').forEach(el => el.classList.remove('active'));
  document.querySelector(`.flow-step[data-step="${currentStep}"]`).classList.add('active');
}
// Aumente o número máximo de passos para 4
function nextStep() {
    if (currentStep === 0 && !selectedSetorId) {
        Swal.fire('Atenção!','Selecione um setor','warning'); return;
    }
    if (currentStep < 4) currentStep++;  // Alterado de 3 para 4
    showStep();
    if (currentStep === 3) loadEscolas(); // Mantém a carga de escolas no passo 3
}
function prevStep() {
  if (currentStep > 0) currentStep--;
  showStep();
}
function selectSetor(card) {
  document.querySelectorAll('.setor-card').forEach(c=>c.classList.remove('selected'));
  card.classList.add('selected');
  selectedSetorId = card.dataset.id;
}
function addQuestion() {
  const container = document.getElementById('perguntas-container');
  const totalPerguntas = container.querySelectorAll('.question-card').length;
  const novaOrdem = totalPerguntas + 1;

  const clone = document.querySelector('.question-card').cloneNode(true);
  clone.querySelector('.question-text').value = '';
  clone.querySelector('.question-type').value = 'SN';
  clone.querySelector('.question-order').value = novaOrdem;

  container.appendChild(clone);
}

function updateCounter() {
  document.getElementById('selected-counter').textContent =
    `${escolasSelecionadas.size} selecionada${escolasSelecionadas.size!==1?'s':''}`;
}

function toggleAllVisible() {
    const cards = document.querySelectorAll('#escolas-container .card:not(.d-none)');
    const allSelected = Array.from(cards).every(card => 
        escolasSelecionadas.has(card.dataset.id)
    );

    cards.forEach(card => {
        const id = card.dataset.id;
        const badge = card.querySelector('.badge-estado');
        
        if (allSelected) {
            escolasSelecionadas.delete(id);
            card.classList.remove('state-selected');
            badge.innerHTML = 'Disponível ➕';
        } else {
            if (!escolasSelecionadas.has(id)) {
                escolasSelecionadas.add(id);
                card.classList.add('state-selected');
                badge.innerHTML = 'Vinculada ✕';
            }
        }
    });
    
    updateCounter();
}

let currentPage = 1;
let totalPages = 1;
function toggleEscola(id) {
  const pill = document.querySelector(`.escola-pill[data-id="${id}"]`);
  if (escolasSelecionadas.has(id)) {
    escolasSelecionadas.delete(id); pill.classList.remove('selected');
  } else {
    escolasSelecionadas.add(id); pill.classList.add('selected');
  }
  updateCounter();
}

async function loadEscolas(search = '', page = 1) {
  try {
    const searchInput = document.getElementById('search-escolas');
    const currentSearch = searchInput.value;
    
    const escolasApiUrl = `{% url 'escolas-list' %}?search=${encodeURIComponent(currentSearch)}&page=${page}`;
    const res = await fetch(escolasApiUrl);
    
    if (!res.ok) throw new Error('Erro na resposta da API');
    
    const data = await res.json();
    
    currentPage = page;
    totalPages = data.total_pages || 1;
    
    const container = document.getElementById('escolas-container');
    container.innerHTML = '';

    data.results.forEach(escola => {
      const card = document.createElement('div');
      const idStr = escola.id.toString();
      const isSelected = escolasSelecionadas.has(idStr);
      const imgUrl = escola.foto_fachada_url || "{% static 'images/default-school.jpeg' %}";

      card.className = 'col-md-6 mb-3';
      card.innerHTML = `
        <div class="card ${isSelected ? 'state-selected' : ''}" 
             data-id="${idStr}" 
             title="${isSelected ? 'Clique para remover' : 'Clique para adicionar'}"
             style="cursor: pointer;">
          <div class="row g-0">
            <div class="col-md-4 position-relative">
              <img src="${imgUrl}" 
                   class="img-fluid rounded-start" 
                   style="height: 150px; object-fit: cover;">
              <span class="badge-estado">
                ${isSelected ? 'Vinculada ✕' : 'Disponível ➕'}
              </span>
            </div>
            <div class="col-md-8">
              <div class="card-body p-3">
                <h6 class="card-title mb-1">${escola.nome}</h6>
                <div class="small text-muted mb-2">
                  <div>INEP: ${escola.inep}</div>
                  <div>Endereço: ${escola.endereco}</div>
                  <div class="mt-1">
                    <i class="fas fa-user-tie me-1"></i>
                    ${escola.nome_gestor}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      card.querySelector('.card').addEventListener('click', () => {
        const id = idStr;
        const cardElement = card.querySelector('.card');
        const badge = cardElement.querySelector('.badge-estado');

        if (escolasSelecionadas.has(id)) {
          cardElement.classList.remove('state-selected');
          escolasSelecionadas.delete(id);
          badge.innerHTML = 'Disponível ➕';
        } else {
          cardElement.classList.add('state-selected');
          escolasSelecionadas.add(id);
          badge.innerHTML = 'Vinculada ✕';
        }
        updateCounter();
      });

      container.appendChild(card);
    });

    const paginationContainer = document.getElementById('pagination-container');
    paginationContainer.innerHTML = `
      <div class="pagination-controls">
        <button ${currentPage === 1 ? 'disabled' : ''} 
                class="btn btn-sm btn-outline-primary prev-page">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="mx-2">Página ${currentPage} de ${totalPages}</span>
        <button ${currentPage >= totalPages ? 'disabled' : ''} 
                class="btn btn-sm btn-outline-primary next-page">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    `;

    // Adicione event listeners corretamente
    paginationContainer.querySelector('.prev-page').addEventListener('click', () => {
      loadEscolas(currentSearch, currentPage - 1);
    });
    
    paginationContainer.querySelector('.next-page').addEventListener('click', () => {
      loadEscolas(currentSearch, currentPage + 1);
    });

    updateCounter();

  } catch (err) {
    console.error('Erro ao carregar escolas:', err);
    Swal.fire('Erro', 'Não foi possível carregar as escolas', 'error');
  }
}
function refreshCardState(cardElement, id) {
  const badge = cardElement.querySelector('.badge-estado');
  const isSelected = escolasSelecionadas.has(id);

  cardElement.classList.remove('state-selected', 'state-removing', 'state-adding');

  if (isSelected) {
    cardElement.classList.add('state-selected');
    badge.innerHTML = 'Vinculada ✕';
  } else {
    badge.innerHTML = 'Disponível ➕';
  }
}
document.getElementById('search-escolas').addEventListener('input', function(e) {
  loadEscolas(e.target.value, 1); // Sempre volta para a primeira página
});


async function submitForm() {
    // Convert Set para Array de números
    const escolasArray = Array.from(escolasSelecionadas).map(Number);

    const data = {
        titulo: document.getElementById('titulo').value,
        descricao: document.getElementById('descricao').value,
        setor: Number(selectedSetorId),
        perguntas: Array.from(document.querySelectorAll('.question-card')).map(c => ({
            texto: c.querySelector('.question-text').value,
            tipo_resposta: c.querySelector('.question-type').value,
            ordem: parseInt(c.querySelector('.question-order').value)
        })),
        escolas_destino: escolasArray,
        data_limite: document.getElementById('data-limite').value,
        frequencia: document.getElementById('frequencia').value
    };

    // Validação melhorada
    const errors = [];
    if (!data.titulo) errors.push('Título é obrigatório');
    if (!data.setor) errors.push('Setor é obrigatório');
    if (!data.data_limite) errors.push('Data limite é obrigatória');
    
    data.perguntas.forEach((p, i) => {
        if (!p.texto) errors.push(`Pergunta ${i+1}: Texto é obrigatório`);
        if (isNaN(p.ordem) || p.ordem < 1) errors.push(`Pergunta ${i+1}: Ordem inválida`);
    });

    if (errors.length > 0) {
        Swal.fire('Erro!', errors.join('<br>'), 'error');
        return;
    }

    try {
        const resp = await fetch('{% url "questionarios-add" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await resp.json();
        
        if (resp.ok) {
            Swal.fire({icon: 'success', title: 'Sucesso!', html: 'Questionário criado'})
                .then(() => {
                    window.location = `{% url 'gerenciar_perguntas' 0 %}`.replace('0', result.id);
                });
        } else {
            const errors = result.errors ? Object.entries(result.errors).map(([k,v]) => `${k}: ${v}`) : ['Erro desconhecido'];
            Swal.fire('Erro', errors.join('<br>'), 'error');
        }
    } catch (error) {
        Swal.fire('Erro', 'Falha na comunicação com o servidor', 'error');
    }
}

document.addEventListener('DOMContentLoaded',showStep);
</script>
{% endblock %}
