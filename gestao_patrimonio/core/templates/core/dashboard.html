{% extends 'gestao_patrimonio/base.html' %}

{% block title %}Dashboard de Inventário{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Cards de Resumo -->
    <div class="row g-4 my-2">
        <div class="col-12 col-md-4 col-xl-4">
            <div class="card shadow border-start-primary h-100">
                <div class="card-body">
                    <h5 class="text-muted mb-2">Total de Bens</h5>
                    <p class="h1 text-primary">{{ total_bens }}</p>
                    <div class="mt-3">
                        <span class="badge bg-success me-1">Ativo: {{ status_counts.ativo|default:"0" }}</span>
                        <span class="badge bg-info me-1">Manutenção: {{ status_counts.manutencao|default:"0" }}</span>
                        <span class="badge bg-warning">Descartado: {{ status_counts.descartado|default:"0" }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="col-12 col-md-4 col-xl-4">
            <div class="card shadow border-start-success h-100">
                <div class="card-body">
                    <h5 class="text-muted mb-2">Valor Total</h5>
                    <p class="h1 text-success">R$ {{ total_valor|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4 col-xl-4">
            <div class="card shadow border-start-warning h-100">
                <div class="card-body">
                    <h5 class="text-muted mb-2">Mov. Hoje</h5>
                    <p class="h1 text-warning">{{ movimentacoes_hoje }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Principais -->
    <div class="row g-4 my-2">
        <div class="col-12 col-lg-8">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Distribuição por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartCategorias" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Status dos Bens</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartStatus" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção Inferior -->
    <div class="row g-4 my-2">
        <div class="col-12 col-lg-6">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Movimentações Recentes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Bem</th>
                                    <th>Origem</th>
                                    <th>Destino</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mov in recent_movements %}
                                <tr>
                                    <td>{{ mov.bem.nome|truncatechars:20 }}</td>
                                    <td>{{ mov.origem.nome|truncatechars:15 }}</td>
                                    <td>{{ mov.destino.nome|truncatechars:15 }}</td>
                                    <td>{{ mov.data_movimentacao|date:"H:i d/m" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">Nenhuma movimentação recente</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="card-title mb-0">Departamentos com Mais Bens</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartDepartamentos" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Configuração de cores
    const colors = {
        primary: '#4e73df',
        success: '#1cc88a',
        info: '#36b9cc',
        warning: '#f6c23e',
        danger: '#e74a3b',
        secondary: '#858796'
    };

    // Gráfico de Categorias
    new Chart(document.getElementById('chartCategorias'), {
        type: 'bar',
        data: {
            labels: [{% for cat in categorias %}"{{ cat.nome }}",{% endfor %}],
            datasets: [{
                label: 'Quantidade',
                data: [{% for cat in categorias %}{{ cat.qtd }},{% endfor %}],
                backgroundColor: colors.primary,
                borderColor: colors.primary,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f8f9fa' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Gráfico de Status
    new Chart(document.getElementById('chartStatus'), {
    type: 'doughnut',
    data: {
        labels: [{% for key, count in status_counts.items %}"{{ key|title }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for key, count in status_counts.items %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [colors.primary, colors.success, colors.warning],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
        }
    }
});

    // Gráfico de Departamentos
    new Chart(document.getElementById('chartDepartamentos'), {
    type: 'bar',  // Troque de 'horizontalBar' para 'bar'
    data: {
        labels: [{% for dep in departamentos %}"{{ dep.nome }}",{% endfor %}],
        datasets: [{
            label: 'Bens',
            data: [{% for dep in departamentos %}{{ dep.qtd }},{% endfor %}],
            backgroundColor: colors.info,
            borderColor: colors.info,
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',  // Essa opção faz com que as barras sejam exibidas horizontalmente
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { beginAtZero: true, grid: { color: '#f8f9fa' } },
            y: { grid: { display: false } }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

</script>
{% endblock %}