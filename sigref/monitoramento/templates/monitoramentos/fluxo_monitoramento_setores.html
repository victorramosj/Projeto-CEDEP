{% extends 'cedepe/base.html' %}
{% load static custom_tags %}

{% block title %}Fluxo de Monitoramento por Setores{% endblock %}
{% block extra_style %}
{{ block.super }}
<style>
    .state-selected {
        border-color: #198754 !important;
        background: #f8fff9;
    }

    .state-adding {
        border-color: #0d6efd !important;
        animation: pulse-blue 1s;
    }

    .state-removing {
        border-color: #dc3545 !important;
        animation: pulse-red 1s;
    }

   
    .state-selected .badge-estado {
        color: #198754;
        
    }

    .state-removing .badge-estado {
        color: #dc3545;
        
    }

    .state-adding .badge-estado {
        color: #0d6efd;
        
    }

    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.3);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }

    @keyframes pulse-red {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.3);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Monitoramento por Setores</h2>

        <!-- Botão para o Dashboard -->
        <a href="{% url 'dashboard_monitoramentos' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>


    <!-- Passo 1: Seleção de Setor -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-sitemap me-2"></i>Selecione um Setor
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="list-group">
                        {% for setor in setores_permitidos %}
                        <a href="?setor={{ setor.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center 
                                      {% if setor_selecionado.id == setor.id %}active{% endif %}">
                            {{ setor.hierarquia_completa }}
                            <span class="badge bg-secondary rounded-pill">{{ setor.questionario_set.count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-8">
                    {% if setor_selecionado %}
                    <h4>{{ setor_selecionado.hierarquia_completa }}</h4>
                    <p class="text-muted">{{ setor_selecionado.questionario_set.count }} questionários disponíveis</p>
                    {% else %}
                    <div class="alert alert-info">
                        Selecione um setor à esquerda para ver os questionários disponíveis
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Passo 2: Questionários do Setor -->
    {% if setor_selecionado %}
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-list me-2"></i>Escolha um Questionário
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    {% if setor_selecionado.questionario_set.all %}
                    <div class="list-group">
                        {% for questionario in setor_selecionado.questionario_set.all %}
                        <a href="?setor={{ setor_selecionado.id }}&questionario={{ questionario.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
              {% if questionario_selecionado.id == questionario.id %}active{% endif %}">
                            <div>
                                <h6 class="mb-1">{{ questionario.titulo }}</h6>
                                <small class="text-muted">{{ questionario.descricao|truncatechars:80 }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ questionario.escolas_destino.count }}</span>
                        </a>
                        {% endfor %}

                        {% if user.is_authenticated and user.is_staff %}
                        <!-- Botão estilizado como item da lista -->
                        <a href="{% url 'criar-questionario' setor_selecionado.id %}"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-success">
                            <div>
                                <h6 class="mb-1"><i class="bi bi-plus-circle me-2"></i> Criar novo questionário</h6>
                                <small class="text-muted">Clique para adicionar um novo questionário para este
                                    setor</small>
                            </div>
                        </a>
                        {% endif %}

                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Nenhum questionário disponível para este setor.
                        {% if user.is_authenticated and user.is_staff %}
                        <a href="{% url 'criar-questionario' setor_selecionado.id %}" class="alert-link">
                            Criar novo questionário
                        </a>

                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    {% if questionario_selecionado %}
                    <h5>{{ questionario_selecionado.titulo }}</h5>
                    <p class="small">{{ questionario_selecionado.descricao }}</p>
                    <div class="d-grid gap-2">
                        <a href="{% url 'gerenciar_perguntas' questionario_selecionado.id %}"
                            class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i> Editar Perguntas
                        </a>
                    </div>

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Passo 3: Escolas e Monitoramentos -->
    {% if questionario_selecionado %}
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-school me-2"></i>Escolas e Monitoramentos
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>Escolas Vinculadas</h6>
                    <div class="list-group mb-4">
                        {% for escola in questionario_selecionado.escolas_destino.all %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <span>{{ escola.nome }}</span>
                                <span class="badge bg-secondary">{{ escola.inep }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="btn btn-outline-success btn-sm w-100" data-bs-toggle="modal"
                        data-bs-target="#assignSchoolsModal">
                        <i class="fas fa-plus"></i> Adicionar Escolas
                    </button>
                </div>

                <div class="col-md-8">
                    <h6>Últimos Monitoramentos</h6>
                    <div class="list-group">
                        {% for monitoramento in monitoramentos %}
                        <a href="{% url 'detalhe_monitoramento' monitoramento.id %}"
                            class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ monitoramento.escola.nome }}</h6>
                                    <small class="text-muted">
                                        {{ monitoramento.data_envio|date:"d/m/Y H:i" }}
                                        {% if monitoramento.respondido_por %}
                                        - {{ monitoramento.respondido_por.nome_completo }}
                                        {% endif %}
                                    </small>
                                </div>
                                <span
                                    class="badge bg-{% if monitoramento.status == 'R' %}success{% elif monitoramento.status == 'U' %}danger{% else %}warning{% endif %}">
                                    {{ monitoramento.get_status_display }}
                                </span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-muted">
                            Nenhum monitoramento registrado para este questionário
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<!-- Modal para Adicionar Escolas -->
<div class="modal fade" id="assignSchoolsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Escolas ao Questionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <input type="text" id="search-escolas" class="form-control form-control-sm w-75"
                        placeholder="Buscar por nome, INEP, endereço ou email...">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" id="prev-page">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3" id="current-page">1</span>
                        <button class="btn btn-sm btn-outline-secondary" id="next-page">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- contador de selecionadas -->
                <div id="escolas-counter" class="mb-2 text-muted small"></div>

                <!-- container onde os cards serão injetados -->
                <div id="escolas-container" class="row g-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="saveSchoolsBtn" class="btn btn-primary btn-sm">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
{% if questionario_selecionado %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modalEl = document.getElementById('assignSchoolsModal');
        if (!modalEl) {
            console.error('Modal assignSchoolsModal não encontrado');
            return;
        }

        const assignUrl = "{% url 'assign_escolas' questionario_selecionado.id %}";
        const escolasApiUrl = "{% url 'escolas-list' %}";

        let escolasSelecionadas = new Set();
        let currentPage = 1, totalPages = 1;

        const container = modalEl.querySelector('#escolas-container');
        const searchInput = modalEl.querySelector('#search-escolas');
        const counterEl = modalEl.querySelector('#escolas-counter');
        const prevBtn = modalEl.querySelector('#prev-page');
        const nextBtn = modalEl.querySelector('#next-page');
        const saveBtn = document.getElementById('saveSchoolsBtn');
        const pageLabel = document.getElementById('current-page');

        [container, searchInput, counterEl, prevBtn, nextBtn, saveBtn, pageLabel].forEach(el => {
            if (!el) console.error('Elemento não encontrado no modal:', el);
        });

        function updateCounter() {
            if (!counterEl) return;
            const count = escolasSelecionadas.size;
            counterEl.textContent = count
                ? `${count} escola(s) selecionada(s)`
                : '';
        }

        async function fetchEscolas() {
            try {
                const q = encodeURIComponent(searchInput.value);
                const url = `${escolasApiUrl}?page=${currentPage}&search=${q}`;
                console.log('Buscando escolas em:', url);
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                console.log('Dados recebidos:', data);
                renderEscolas(data);
            } catch (err) {
                console.error('Erro no fetchEscolas:', err);
                container.innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            Erro ao carregar escolas: ${err.message}
          </div>
        </div>
      `;
            }
        }

        function renderEscolas(data) {
            // Reset do container
            container.innerHTML = '';

            // Tratamento para dados vazios
            if (!data.results || data.results.length === 0) {
                container.innerHTML = `
      <div class="col-12">
        <div class="alert alert-warning">
          Nenhuma escola encontrada com o filtro atual
        </div>
      </div>
    `;
                return;
            }

            // Renderização dos cards
            data.results.forEach(escola => {
                const card = document.createElement('div');
                const idStr = escola.id.toString();
                const isSelected = escolasSelecionadas.has(idStr);
                const imgUrl = escola.foto_fachada_url || "{% static 'images/default-school.jpeg' %}";

                // Determinar o estado inicial
                const tooltipText = isSelected ? "Clique para remover esta escola" : "Clique para adicionar esta escola";
                const stateClass = isSelected ? 'state-selected' : '';
                const badgeText = isSelected ? 'Vinculada ✅' : 'Disponível ➕';

                card.className = 'col-md-6';
                card.innerHTML = `
<div class="card ${stateClass}" data-id="${escola.id}" title="${tooltipText}" style="cursor: pointer;">
      <div class="row g-0">
        <div class="col-md-4 position-relative " >
          <img src="${imgUrl}" 
               class="img-fluid rounded-start" 
               style="height: 150px; object-fit: cover;">
          <span class="badge-estado" title="${tooltipText}">
            ${badgeText}
          </span>
        </div>
        <div class="col-md-8">
          <div class="card-body p-3">
            <h6 class="card-title mb-1">${escola.nome}</h6>
            <div class="small text-muted mb-2" title="clique para adicionar">
              <div>INEP: ${escola.inep}</div>
              <div>Endereço: ${escola.endereco}</div>
              <div class="mt-1">
                <i class="fas fa-user-tie me-1"></i>
                ${escola.nome_gestor}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

                // Adiciona evento de clique
                card.querySelector('.card').addEventListener('click', () => {
                    const cardElement = card.querySelector('.card');
                    const badge = cardElement.querySelector('.badge-estado');
                    const id = escola.id.toString();

                    if (escolasSelecionadas.has(id)) {
                        // Estado de remoção
                        cardElement.classList.remove('state-selected');
                        cardElement.classList.add('state-removing');
                        badge.innerHTML = 'Clique para remover ✕';

                        // Delay para permitir feedback visual
                        setTimeout(() => {
                            cardElement.classList.remove('state-removing');
                            escolasSelecionadas.delete(id);
                            updateCounter();
                            refreshCardState(cardElement, id);
                        }, 500);

                    } else {
                        // Estado de adição
                        cardElement.classList.add('state-adding');
                        badge.innerHTML = 'Adicionando... ✓';

                        setTimeout(() => {
                            cardElement.classList.remove('state-adding');
                            escolasSelecionadas.add(id);
                            updateCounter();
                            refreshCardState(cardElement, id);
                        }, 500);
                    }
                });

                container.appendChild(card);
            });

            // Função para atualizar o estado do card
            function refreshCardState(cardElement, id) {
                const badge = cardElement.querySelector('.badge-estado');
                const isSelected = escolasSelecionadas.has(id);

                cardElement.classList.remove('state-selected', 'state-removing', 'state-adding');

                if (isSelected) {
                    cardElement.classList.add('state-selected');
                    badge.innerHTML = 'Vinculada ✕';
                } else {
                    badge.innerHTML = 'Disponível ➕';
                }
            }
            // Atualiza controles de paginação
            totalPages = Math.ceil(data.count / 10);
            pageLabel.textContent = `Página ${currentPage} de ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            updateCounter();
        }

        // Controle de paginação e busca
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                fetchEscolas();
            }
        };
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchEscolas();
            }
        };
        searchInput.oninput = () => {
            currentPage = 1;
            fetchEscolas();
        };

        // Salvar seleção
        saveBtn.onclick = () => {
            fetch(assignUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    escolas: Array.from(escolasSelecionadas).map(i => parseInt(i, 10))
                })
            })
                .then(r => {
                    if (r.ok) return location.reload();
                    alert('Erro ao salvar escolas.');
                })
                .catch(err => {
                    console.error('Erro ao salvar:', err);
                    alert('Falha na requisição.');
                });
        };

        // Ao abrir o modal, buscar IDs já atribuídos + renderizar
        modalEl.addEventListener('shown.bs.modal', async () => {
            try {
                const res = await fetch(assignUrl);
                const data = await res.json();
                escolasSelecionadas = new Set(data.assigned.map(id => id.toString()));
                await fetchEscolas();
            } catch (err) {
                console.error('Erro ao buscar atribuídas:', err);
            }
        });
    });
</script>
{% endif %}

{% endblock %}