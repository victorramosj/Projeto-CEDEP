{% extends "cedepe/base.html" %}

{% block title %}Criar Aviso{% endblock %}

{% block content %}
<style>
    /* [NOVO] Classe para for√ßar a quebra de texto dentro dos badges */
    .badge-wrap {
        white-space: normal; /* Permite que o texto quebre para a pr√≥xima linha */
        word-break: break-all; /* For√ßa a quebra de palavras muito longas */
        text-align: left;    /* Alinha o texto √† esquerda quando quebrado, para melhor leitura */
        line-height: 1.4;    /* Melhora o espa√ßamento entre as linhas quando o texto quebra */
    }

    /* Estilo para garantir que o carrossel tenha uma altura m√≠nima */
    #carouselEscolasContainer .carousel {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        padding-top: 1rem;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .carousel-dark .carousel-indicators [data-bs-target] {
        background-color: #000;
    }

    /* [MODIFICADO] Adicionado padding horizontal (4rem) para n√£o sobrepor as setas */
    .carousel-item-content {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        /* Adiciona padding para afastar os badges das setas de controle */
        padding: 0 4rem 2.5rem 4rem; /* Topo | Direita/Esquerda | Fundo */
    }
</style>

<div class="container mt-4 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-md-center">
            <h4 class="h5 mb-2 mb-md-0 fw-light">
                <i class="bi bi-bell-fill me-2 text-primary"></i>
                Criar Novo Aviso
            </h4>
            <a href="{% url 'listar_avisos' %}" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center">
                <i class="bi bi-list-ul me-2"></i>Ver Lista de Avisos
            </a>
        </div>

        <div class="card-body p-4">

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" id="avisoForm">
                {% csrf_token %}

                <h6 class="text-muted fw-bold text-uppercase small mb-3">Detalhes do Aviso</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <label for="titulo" class="form-label fw-semibold">T√≠tulo</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-fonts"></i></span>
                            <input type="text" name="titulo" id="titulo" class="form-control" required value="{{ request.POST.titulo }}" placeholder="Ex: Reuni√£o de Pais e Mestres">
                        </div>
                    </div>
                    <div class="col-md-12">
                        <label for="mensagem" class="form-label fw-semibold">Mensagem</label>
                         <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-chat-left-text"></i></span>
                            <textarea name="mensagem" id="mensagem" class="form-control" rows="4" required placeholder="Digite a mensagem completa do aviso aqui...">{{ request.POST.mensagem }}</textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="prioridade" class="form-label fw-semibold">Prioridade</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-tags"></i></span>
                            <select name="prioridade" id="prioridade" class="form-select">
                                <option value="baixa" {% if request.POST.prioridade == 'baixa' %}selected{% endif %}>Baixa</option>
                                <option value="normal" {% if not request.POST.prioridade or request.POST.prioridade == 'normal' %}selected{% endif %}>Normal</option>
                                <option value="alta" {% if request.POST.prioridade == 'alta' %}selected{% endif %}>Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="data_expiracao" class="form-label fw-semibold">Data e Hora de Expira√ß√£o <span class="text-muted">(opcional)</span></label>
                         <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                            <input type="datetime-local" name="data_expiracao" id="data_expiracao" class="form-control" value="{{ request.POST.data_expiracao }}">
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <h6 class="text-muted fw-bold text-uppercase small mb-3">Destinat√°rios</h6>
                <div class="mb-3 p-3 border rounded">
                    <label class="form-label fw-semibold">Selecione uma ou mais escolas para o aviso:</label>
                    <input type="text" id="termo_busca_checkbox" class="form-control mb-2" placeholder="üîé Buscar escola por Nome ou INEP..." onkeyup="filtrarListaEscolas()">
                    <div id="listaEscolasCheckboxes" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        {% if escolas %}
                            {% for escola in escolas %}
                            <div class="form-check escola-item" data-nome="{{ escola.nome|lower|escapejs }}" data-inep="{{ escola.inep|default_if_none:''|escapejs }}">
                                <input class="form-check-input escola-checkbox" type="checkbox" name="escola_id" value="{{ escola.id }}" id="escola_check_{{ escola.id }}">
                                <label class="form-check-label" for="escola_check_{{ escola.id }}">
                                    {{ escola.nome }} <span class="text-muted small">(INEP: {{ escola.inep|default_if_none:'N/A' }})</span>
                                </label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted m-0 text-center">Nenhuma escola dispon√≠vel para sele√ß√£o.</p>
                        {% endif %}
                    </div>
                    <div class="mt-3">
                        <button type="button" id="btnMarcarTodasEscolasSistema" class="btn btn-outline-primary btn-sm me-2">
                            <i class="bi bi-check2-square"></i> Marcar Todas
                        </button>
                        <button type="button" id="btnLimparSelecaoEscolas" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-square"></i> Limpar Sele√ß√£o
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold">Escolas Selecionadas:</label>
                    <div id="carouselEscolasContainer">
                        </div>
                </div>

                <div class="alert alert-warning d-flex align-items-center" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                  <div>
                    <h6 class="alert-heading">Aten√ß√£o!</h6>
                    <ul class="mb-0 ps-3">
                        <li>Verifique se todas as informa√ß√µes est√£o corretas antes de publicar.</li>
                        <li>Uma vez publicado, o aviso s√≥ poder√° ser <strong>editado ou apagado</strong>.</li>
                        <li>N√£o √© poss√≠vel alterar as escolas de um aviso j√° enviado.</li>
                    </ul>
                  </div>
                </div>
            </form>
        </div>

        <div class="card-footer text-end bg-light p-3">
            <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#modalConfirmacao" id="btnPublicar" disabled>
                <i class="bi bi-send-check-fill me-2"></i> Publicar Aviso
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmacaoLabel">Confirmar Publica√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>O aviso ser√° enviado para as seguintes escolas:</p>
                <div id="modalConfirmacaoEscolas" class="mb-3 d-flex flex-wrap gap-2">
                    </div>
                <div class="alert alert-danger">
                    <strong>Aten√ß√£o:</strong> Ap√≥s confirmar, a a√ß√£o n√£o poder√° ser desfeita. Voc√™ s√≥ poder√° editar o conte√∫do ou apagar o aviso completamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarPublicacao">
                    <i class="bi bi-check-circle me-2"></i>Confirmar e Enviar
                </button>
            </div>
        </div>
    </div>
</div>


<script>
// Fun√ß√£o de busca (sem altera√ß√µes)
function filtrarListaEscolas() {
    const termoBuscaInput = document.getElementById('termo_busca_checkbox');
    const termo = termoBuscaInput.value.toLowerCase().trim();
    document.querySelectorAll('.escola-item').forEach(item => {
        const nome = item.dataset.nome;
        const inep = item.dataset.inep;
        item.style.display = (nome.includes(termo) || (inep && inep.includes(termo))) ? '' : 'none';
    });
}

/**
 * [MODIFICADO]
 * Gera o carrossel e o conte√∫do do modal, aplicando a classe .badge-wrap para
 * garantir a quebra de linha correta.
 */
function atualizarDisplayEscolasSelecionadas() {
    const carouselContainer = document.getElementById('carouselEscolasContainer');
    const modalConfirmacaoEscolasDiv = document.getElementById('modalConfirmacaoEscolas');
    
    modalConfirmacaoEscolasDiv.innerHTML = '';
    carouselContainer.innerHTML = '';

    const checkedCheckboxes = Array.from(document.querySelectorAll('.escola-checkbox:checked'));
    const totalEscolas = document.querySelectorAll('.escola-checkbox').length;
    const escolasPorSlide = 6;

    // 1. Nenhuma escola selecionada
    if (checkedCheckboxes.length === 0) {
        carouselContainer.innerHTML = `<div class="p-3 border rounded bg-light text-muted text-center">Nenhuma escola selecionada.</div>`;
    
    // 2. TODAS as escolas selecionadas
    } else if (checkedCheckboxes.length === totalEscolas) {
        const todasBadge = `<div class="p-3 border rounded bg-light text-center"><span class="badge bg-primary fs-6 fw-normal badge-wrap">Todas as ${totalEscolas} escolas selecionadas</span></div>`;
        carouselContainer.innerHTML = todasBadge;
        modalConfirmacaoEscolasDiv.innerHTML = `<span class="badge bg-primary fs-6 fw-normal badge-wrap">Todas as ${totalEscolas} escolas selecionadas</span>`;
    
    // 3. Escolas selecionadas (L√≥gica do Carrossel)
    } else {
        // Preenche o modal de confirma√ß√£o (sem carrossel)
        checkedCheckboxes.forEach(checkbox => {
            const escolaNome = checkbox.closest('.escola-item').querySelector('label').textContent.trim();
            // [MODIFICADO] Adiciona a classe .badge-wrap
            modalConfirmacaoEscolasDiv.innerHTML += `<span class="badge text-bg-info badge-wrap">${escolaNome}</span>`;
        });

        // Constr√≥i o Carrossel
        const carouselId = 'escolasCarousel';
        let indicatorsHtml = '';
        let slidesHtml = '';
        
        for (let i = 0; i < checkedCheckboxes.length; i += escolasPorSlide) {
            const slideIndex = i / escolasPorSlide;
            const activeClass = (slideIndex === 0) ? 'active' : '';
            
            indicatorsHtml += `<button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${slideIndex}" class="${activeClass}" aria-current="${activeClass ? 'true' : 'false'}" aria-label="Slide ${slideIndex + 1}"></button>`;
            
            const slideItems = checkedCheckboxes.slice(i, i + escolasPorSlide);
            let slideContent = '';
            slideItems.forEach(checkbox => {
                const escolaNome = checkbox.closest('.escola-item').querySelector('label').textContent.trim();
                 // [MODIFICADO] Adiciona a classe .badge-wrap
                slideContent += `<span class="badge text-bg-info badge-wrap">${escolaNome}</span>`;
            });
            
            slidesHtml += `
                <div class="carousel-item ${activeClass}">
                    <div class="carousel-item-content">
                        ${slideContent}
                    </div>
                </div>`;
        }
        
        carouselContainer.innerHTML = `
            <div id="${carouselId}" class="carousel carousel-dark slide" data-bs-ride="false">
                <div class="carousel-indicators">${indicatorsHtml}</div>
                <div class="carousel-inner">${slidesHtml}</div>
                <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Pr√≥ximo</span>
                </button>
            </div>`;
    }

    // Valida√ß√£o para habilitar o bot√£o de publica√ß√£o (l√≥gica inalterada)
    const titulo = document.getElementById('titulo').value.trim();
    const mensagem = document.getElementById('mensagem').value.trim();
    const btnPublicar = document.getElementById('btnPublicar');
    btnPublicar.disabled = !(titulo && mensagem && checkedCheckboxes.length > 0);
}

// Listener principal do DOM
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('avisoForm');
    
    // Gatilhos para atualiza√ß√£o da UI
    document.getElementById('titulo').addEventListener('input', atualizarDisplayEscolasSelecionadas);
    document.getElementById('mensagem').addEventListener('input', atualizarDisplayEscolasSelecionadas);
    
    document.querySelectorAll('.escola-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', atualizarDisplayEscolasSelecionadas);
    });

    document.getElementById('btnMarcarTodasEscolasSistema').addEventListener('click', () => {
        document.querySelectorAll('.escola-checkbox').forEach(c => { c.checked = true; });
        atualizarDisplayEscolasSelecionadas();
    });

    document.getElementById('btnLimparSelecaoEscolas').addEventListener('click', () => {
        document.querySelectorAll('.escola-checkbox').forEach(c => { c.checked = false; });
        atualizarDisplayEscolasSelecionadas();
    });

    document.getElementById('confirmarPublicacao').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publicando...';
        form.submit();
    });

    // Carga inicial
    atualizarDisplayEscolasSelecionadas();
});
</script>

{% endblock %}
