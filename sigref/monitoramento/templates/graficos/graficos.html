{% extends 'cedepe/base.html' %}
{% load static %}

{% block title %}{{ questionario.titulo }} - Gráficos{% endblock %}

{% block extra_style %}
{{ block.super }}
<style>
    /* Estilos gerais para o container */
    #graficos-main-container {
        background: #f8f9fa; /* Um fundo levemente cinza para destacar os cards */
        padding: 30px 0;
    }

    .chart-card {
        margin-bottom: 25px; /* Espaçamento entre os cards de gráfico */
        border: none; /* Remover a borda padrão do card */
        border-radius: 12px; /* Cantos arredondados */
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Sombra mais suave */
        overflow: hidden; /* Garante que o conteúdo não vaze */
    }

    .chart-card .card-header {
        background-color: #e9ecef; /* Cor de fundo para o cabeçalho do card */
        border-bottom: 1px solid #dee2e6;
        padding: 15px 20px;
        font-weight: 600;
        color: #343a40;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-card .card-body {
        padding: 20px;
    }

    /* Estilos específicos para cada tipo de gráfico */
    .card-sn {
        background-color: #e6ffed; /* Verde claro */
        border-left: 5px solid #28a745; /* Borda lateral verde */
    }

    .card-nu {
        background-color: #e0f2ff; /* Azul claro */
        border-left: 5px solid #007bff; /* Borda lateral azul */
    }

    .card-tx {
        background-color: #fefefe; /* Branco para texto */
        border-left: 5px solid #6c757d; /* Borda lateral cinza */
    }

    /* Estilos para informações estatísticas */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .stat-item {
        background-color: rgba(0,0,0,0.03);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85em;
    }

    .stat-item strong {
        display: block;
        font-size: 1.1em;
        color: #343a40;
    }

    /* Estilos para lista de exemplos de texto */
    .text-response-list {
        list-style-type: disc; /* Bolinhas para a lista */
        padding-left: 25px;
        margin-bottom: 0;
    }

    .text-response-list li {
        margin-bottom: 8px;
        color: #495057;
    }

    .no-data-message {
        padding: 40px;
        text-align: center;
        color: #6c757d;
        font-size: 1.2em;
        background-color: #f2f2f2;
        border-radius: 8px;
        margin-top: 30px;
    }

    /* Ocultar barra de rolagem para o cabeçalho fixo */
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 1020; /* Bootstrap navbar z-index is 1030, this is just below */
        background-color: var(--bs-body-bg); /* Use Bootstrap's background color variable */
        padding-bottom: 15px;
        border-bottom: 1px solid var(--bs-border-color-translucent);
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid py-4 sticky-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0 text-primary">{{ questionario.titulo }} - Visão Geral dos Gráficos</h2>
        <button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-2" onclick="history.back()">
            <i class="bi bi-arrow-left"></i> Voltar
        </button>
    </div>
    <div class="row">
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-info"><i class="bi bi-bar-chart-steps me-2"></i>Estatísticas Gerais</h5>
                    <p class="card-text">Total de Monitoramentos: <span class="fw-bold">{{ total_monitoramentos }}</span></p>
                    <p class="card-text">Escolas que Responderam: <span class="fw-bold">{{ escolas|length }}</span></p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-8 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-success"><i class="bi bi-building-fill-check me-2"></i>Escolas com Mais Respostas</h5>
                    {% if escolas_respondentes %}
                    <ul class="list-group list-group-flush">
                        {% for escola_data in escolas_respondentes|slice:":5" %} {# Limitar a 5 para não ficar muito longo #}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                            {{ escola_data.escola__nome }}
                            <span class="badge bg-primary rounded-pill">{{ escola_data.total }}</span>
                        </li>
                        {% endfor %}
                        {% if escolas_respondentes|length > 5 %}
                        <li class="list-group-item text-end px-0 py-2">
                            <small class="text-muted">E mais {{ escolas_respondentes|length|add:"-5" }} escolas...</small>
                        </li>
                        {% endif %}
                    </ul>
                    {% else %}
                    <p class="text-muted">Nenhuma escola respondeu a este questionário ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-4" id="graficos-main-container">
    <div id="graficos-render-area">
        {% if not dados_graficos_json %} {# Usaremos um novo nome para o JSON parseado no contexto da view #}
        <div class="alert alert-info no-data-message" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Nenhum dado disponível para exibir gráficos deste questionário.
            Certifique-se de que há monitoramentos e respostas registradas.
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    Chart.register(ChartDataLabels); // Registrar o plugin globalmente

    const dadosGraficos = JSON.parse('{{ dados_graficos|safe }}');
    const graficosRenderArea = document.getElementById('graficos-render-area');

    if (dadosGraficos.length === 0) {
        // A mensagem de "nenhum dado" já está no HTML via Django template para melhor UX.
    }

    dadosGraficos.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'card chart-card';

        // Adiciona classe específica para estilização por tipo
        if (item.tipo === 'SN') {
            card.classList.add('card-sn');
        } else if (item.tipo === 'NU') {
            card.classList.add('card-nu');
        } else if (item.tipo === 'TX') {
            card.classList.add('card-tx');
        }

        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        cardHeader.innerHTML = `
            ${item.pergunta}
            <span class="badge bg-secondary">Total de Respostas: ${item.dados.total_respostas}</span>
        `;
        card.appendChild(cardHeader);

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        if (item.tipo === 'SN') {
            if (item.dados.total_respostas > 0) {
                const canvas = document.createElement('canvas');
                canvas.id = `grafico-${index}`;
                canvas.height = 200; // Ajustar a altura para melhor visualização
                cardBody.appendChild(canvas);

                new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: item.dados.labels,
                        datasets: [{
                            data: item.dados.values,
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed.toFixed(1) + '%';
                                            // Adiciona a contagem absoluta no tooltip também
                                            if (context.label === 'Sim') {
                                                label += ` (${item.dados.total_sim} escolas)`;
                                            } else if (context.label === 'Não') {
                                                label += ` (${item.dados.total_nao} escolas)`;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: { // Configuração para exibir as porcentagens
                                color: '#fff', // Cor do texto dos rótulos
                                formatter: (value, context) => {
                                    // Exibe a porcentagem e, opcionalmente, a contagem absoluta
                                    let label = value.toFixed(1) + '%';
                                    if (context.chart.data.labels[context.dataIndex] === 'Sim') {
                                        label += `\n(${item.dados.total_sim})`;
                                    } else if (context.chart.data.labels[context.dataIndex] === 'Não') {
                                        label += `\n(${item.dados.total_nao})`;
                                    }
                                    return label;
                                },
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                textShadow: { // Adiciona sombra para melhor legibilidade
                                    color: 'rgba(0, 0, 0, 0.5)',
                                    blur: 4,
                                    offsetX: 2,
                                    offsetY: 2
                                }
                            },
                            title: { display: false }
                        }
                    }
                });

                const statsDiv = document.createElement('div');
                statsDiv.className = 'stats-grid mt-3';
                statsDiv.innerHTML = `
                    <div class="stat-item"><strong>${item.dados.total_sim}</strong> Sim</div>
                    <div class="stat-item"><strong>${item.dados.perc_sim}%</strong> Sim</div>
                    <div class="stat-item"><strong>${item.dados.total_nao}</strong> Não</div>
                    <div class="stat-item"><strong>${item.dados.perc_nao}%</strong> Não</div>
                `;
                cardBody.appendChild(statsDiv);

            } else {
                cardBody.innerHTML = `<p class="text-muted text-center py-3">Sem respostas para esta pergunta (Sim/Não).</p>`;
            }

        } else if (item.tipo === 'NU') {
            if (item.dados.total_respostas > 0) {
                const canvas = document.createElement('canvas');
                canvas.id = `grafico-${index}`;
                canvas.height = 220;
                cardBody.appendChild(canvas);

                const valueCounts = {};
                item.dados.valores.forEach(val => {
                    valueCounts[val] = (valueCounts[val] || 0) + 1;
                });
                const sortedLabels = Object.keys(valueCounts).sort((a, b) => parseFloat(a) - parseFloat(b));
                const sortedValues = sortedLabels.map(label => valueCounts[label]);

                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            label: 'Frequência',
                            data: sortedValues,
                            backgroundColor: '#007bff',
                            borderRadius: 6,
                            maxBarThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `Valor: ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        return `Frequência: ${context.parsed.y} escolas`;
                                    }
                                }
                            },
                            datalabels: { // Configuração para exibir a frequência acima das barras
                                anchor: 'end', // Posição do rótulo (no final da barra)
                                align: 'top', // Alinhamento do rótulo
                                color: '#333', // Cor do texto
                                formatter: (value) => {
                                    return value + 'x'; // Exemplo: "5x" para 5 ocorrências
                                },
                                font: {
                                    weight: 'bold',
                                    size: 13
                                }
                            },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Valor da Resposta',
                                    font: { size: 14, weight: 'bold' }
                                },
                                grid: { display: false },
                                ticks: { font: { size: 13 } }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Frequência (Nº de Escolas)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                beginAtZero: true,
                                grid: { color: "#e3eafc" },
                                ticks: { font: { size: 13 } }
                            }
                        }
                    }
                });

                const statsDiv = document.createElement('div');
                statsDiv.className = 'stats-grid mt-3';
                statsDiv.innerHTML = `
                    <div class="stat-item">Média: <strong>${item.dados.media.toFixed(2)}</strong></div>
                    <div class="stat-item">Mediana: <strong>${item.dados.mediana.toFixed(2)}</strong></div>
                    <div class="stat-item">Mín: <strong>${item.dados.min}</strong></div>
                    <div class="stat-item">Máx: <strong>${item.dados.max}</strong></div>
                    <div class="stat-item">Desvio Padrão: <strong>${item.dados.desvio_padrao.toFixed(2)}</strong></div>
                `;
                cardBody.appendChild(statsDiv);

            } else {
                cardBody.innerHTML = `<p class="text-muted text-center py-3">Sem respostas para esta pergunta (Numérica).</p>`;
            }

        } else if (item.tipo === 'TX') {
            if (item.dados.exemplos.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'text-response-list';
                item.dados.exemplos.forEach(text => {
                    const li = document.createElement('li');
                    li.innerText = text;
                    ul.appendChild(li);
                });
                cardBody.appendChild(ul);
            } else {
                cardBody.innerHTML = `<p class="text-muted text-center py-3">Sem respostas textuais para esta pergunta.</p>`;
            }
        }
        graficosRenderArea.appendChild(card);
    });
</script>
{% endblock %}