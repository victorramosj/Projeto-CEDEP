{% extends 'cedepe/base.html' %}
{% load static custom_tags %}

{% block title %}Fluxo de Monitoramento por Setores{% endblock %}

{% block extra_style %}
{{ block.super }}
<style>
    /* Estilos existentes para animações e badges - mantidos para consistência */
    .state-selected {
        border-color: #198754 !important;
        background: #f8fff9;
    }

    .state-adding {
        border-color: #0d6efd !important;
        animation: pulse-blue 1s;
    }

    .state-removing {
        border-color: #dc3545 !important;
        animation: pulse-red 1s;
    }

    .state-selected .badge-estado {
        color: #198754;
    }

    .state-removing .badge-estado {
        color: #dc3545;
    }

    .state-adding .badge-estado {
        color: #0d6efd;
    }

    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.3);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }

    @keyframes pulse-red {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.3);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    .badge-estado {
        background-color: rgba(255, 255, 255, 0.85);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    .card:hover .badge-estado {
        background-color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    #loading-spinner {
        width: 2rem;
        height: 2rem;
    }

    /* Novos estilos para layout responsivo e cards de seleção */
    .step-card {
        margin-bottom: 1.5rem;
        border-left: 5px solid var(--bs-primary); /* Indicador visual do passo */
    }

    .step-card.secondary-step {
        border-left-color: var(--bs-info);
    }

    .step-card.third-step {
        border-left-color: var(--bs-success);
    }

    .list-group-scrollable {
        max-height: 400px; /* Altura máxima para listas, com scroll */
        overflow-y: auto;
    }

    .card-body-scrollable {
        max-height: 60vh; /* Altura máxima para o corpo do card de escolas/monitoramentos */
        overflow-y: auto;
    }

    /* Estilo para itens de lista selecionados */
    .list-group-item.active {
        z-index: 2;
        color: var(--bs-list-group-active-color);
        background-color: var(--bs-list-group-active-bg);
        border-color: var(--bs-list-group-active-border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" >
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h2 class="mb-3 mb-md-0 ">Monitoramento por Setores</h2>
        <a href="{% url 'dashboard_monitoramentos' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Voltar para o Dashboard
        </a>
    </div>

    <div class="row">
        <div class="col-lg-4 col-md-5 mb-4">
            <div class="card shadow step-card">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="fas fa-sitemap me-2"></i>
                    <h5 class="card-title mb-0">1. Selecione um Setor</h5>
                </div>
                <div class="card-body list-group-scrollable">
                    <div class="list-group list-group-flush">
                        {% for setor in setores_permitidos %}
                        <a href="?setor={{ setor.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if setor_selecionado.id == setor.id %}active{% endif %}">
                            {{ setor.hierarquia_completa }}
                            <span class="badge bg-secondary rounded-pill">{{ setor.questionario_set.count }}</span>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-muted text-center">Nenhum setor disponível.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7 mb-4">
            {% if setor_selecionado %}
            <div class="card shadow step-card secondary-step">
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <h5 class="card-title mb-0">2. Escolha um Questionário para {{ setor_selecionado.nome }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 list-group-scrollable pe-md-0">
                            {% if setor_selecionado.questionario_set.all %}
                            <div class="list-group list-group-flush">
                                {% for questionario in setor_selecionado.questionario_set.all %}
                                <a href="?setor={{ setor_selecionado.id }}&questionario={{ questionario.id }}"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-start {% if questionario_selecionado.id == questionario.id %}active{% endif %}">
                                    <div class="flex-grow-1 me-2">
                                        <h6 class="mb-1">{{ questionario.titulo }}</h6>
                                        <small class="text-muted d-block">{{ questionario.descricao|truncatechars:100 }}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill mt-1">{{ questionario.escolas_destino.count }}</span>
                                </a>
                                {% endfor %}

                                {% if user.is_authenticated and user.is_staff %}
                                <a href="{% url 'criar-questionario' setor_selecionado.id %}"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-success">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1"><i class="bi bi-plus-circle me-2"></i> Criar novo questionário</h6>
                                        <small class="text-muted">Adicione um novo questionário para este setor.</small>
                                    </div>
                                </a>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="alert alert-warning mb-0" role="alert">
                                Nenhum questionário disponível para este setor.
                                {% if user.is_authenticated and user.is_staff %}
                                <a href="{% url 'criar-questionario' setor_selecionado.id %}" class="alert-link">
                                    Crie um agora!
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 border-start d-flex flex-column justify-content-between pt-3 pt-md-0">
                            {% if questionario_selecionado %}
                            <div>
                                <h5 class="text-info">{{ questionario_selecionado.titulo }}</h5>
                                <p class="small text-muted">{{ questionario_selecionado.descricao }}</p>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{% url 'gerenciar_perguntas' questionario_selecionado.id %}"
                                    class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-edit me-2"></i> Gerenciar Perguntas
                                </a>
                                <a href="{% url 'visualizar_graficos_questionario' questionario_selecionado.id %}"
                                    class="btn btn-outline-info btn-sm" title="Ver Gráficos">
                                    <i class="bi bi-bar-chart me-2"></i> Ver Gráficos
                                </a>
                            </div>
                            {% else %}
                            <div class="alert alert-light border text-center text-muted h-100 d-flex align-items-center justify-content-center" role="alert">
                                <i class="fas fa-info-circle me-2"></i> Selecione um questionário para ver detalhes e ações.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if questionario_selecionado %}
    <div class="card shadow step-card third-step">
        <div class="card-header bg-success text-white d-flex align-items-center">
            <i class="fas fa-school me-2"></i>
            <h5 class="card-title mb-0">3. Escolas Vinculadas e Últimos Monitoramentos</h5>
        </div>
        <div class="card-body card-body-scrollable">
            <div class="row">
                <div class="col-md-5 pe-md-0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 text-success">Escolas Vinculadas</h6>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal"
                            data-bs-target="#assignSchoolsModal">
                            <i class="fas fa-plus me-2"></i> Adicionar Escola
                        </button>
                    </div>

                    <div class="list-group list-group-flush">
                        {% for escola in questionario_selecionado.escolas_destino.all %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex flex-column flex-grow-1 me-2">
                                <span class="fw-bold">{{ escola.nome }}</span>
                                <small class="text-muted">INEP: {{ escola.inep }}</small>
                            </div>
                            <a href="{% url 'dashboard_escola' escola.id %}" class="btn btn-outline-primary btn-sm"
                                title="Acessar dashboard da escola">
                                <i class="fas fa-chart-line"></i> Dashboard
                            </a>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-muted text-center">Nenhuma escola vinculada a este questionário.</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-7 border-start ps-md-4">
                    <h6 class="mb-3 text-info">Últimos Monitoramentos Registrados</h6>
                    <div class="list-group list-group-flush">
                        {% for monitoramento in monitoramentos %}
                        <a href="{% url 'detalhe_monitoramento' monitoramento.id %}"
                            class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ monitoramento.escola.nome }}</h6>
                                {% if monitoramento.foto_comprovante %}
                                <span class="badge bg-info align-self-start"><i class="fas fa-camera me-1"></i> Comprovante</span>
                                {% endif %}
                            </div>
                            <small class="text-muted d-block">
                                {{ monitoramento.criado_em|date:"d/m/Y H:i" }}
                                {% if monitoramento.respondido_por %}
                                – por {{ monitoramento.respondido_por.first_name }} {{ monitoramento.respondido_por.last_name }}
                                {% endif %}
                            </small>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-muted text-center">
                            Nenhum monitoramento registrado para este questionário ainda.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}



</div>
<!-- Modal para Adicionar Escolas -->
<div class="modal fade" id="assignSchoolsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Escolas ao Questionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="w-75 position-relative">
                        <input type="text" id="search-escolas" class="form-control form-control-sm pe-5"
                            placeholder="Buscar por nome, INEP, endereço ou email...">
                        <span class="position-absolute end-0 top-50 translate-middle-y me-2 text-muted">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" id="prev-page">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3" id="current-page">1</span>
                        <button class="btn btn-sm btn-outline-secondary" id="next-page">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div id="escolas-counter" class="text-muted small"></div>
                    <div class="btn-group">
                        <button id="select-all-page-btn" class="btn btn-sm btn-outline-secondary">
                            Selecionar Página
                        </button>
                        <button id="select-all-btn" class="btn btn-sm btn-outline-primary">
                            Selecionar Todas as Escolas
                        </button>
                    </div>
                </div>

                <!-- container onde os cards serão injetados -->
                <div id="escolas-container" class="row g-3"></div>
                
                <div class="mt-3 text-center">
                    <div class="spinner-border text-primary d-none" id="loading-spinner" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="saveSchoolsBtn" class="btn btn-primary btn-sm">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
{% if questionario_selecionado %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('assignSchoolsModal');
    if (!modalEl) return;

    const assignUrl = "{% url 'assign_escolas' questionario_selecionado.id %}";
    const escolasApiUrl = "{% url 'escolas-list' %}";
    const escolasAllIdsUrl = "{% url 'escolas-all-ids' %}";

    let escolasSelecionadas = new Set();
    let currentPage = 1, totalPages = 1;
    let lastFetchedSchools = [];
    let allEscolasIds = new Set(); // Armazenará todos os IDs de escolas

    // Referências
    const container = modalEl.querySelector('#escolas-container');
    const searchInput = modalEl.querySelector('#search-escolas');
    const counterEl = modalEl.querySelector('#escolas-counter');
    const prevBtn = modalEl.querySelector('#prev-page');
    const nextBtn = modalEl.querySelector('#next-page');
    const saveBtn = modalEl.querySelector('#saveSchoolsBtn');
    const pageLabel = modalEl.querySelector('#current-page');
    const selectAllPageBtn = modalEl.querySelector('#select-all-page-btn');
    const selectAllBtn = modalEl.querySelector('#select-all-btn');
    const loadingSpinner = modalEl.querySelector('#loading-spinner');

    // Carregar todos os IDs de escolas uma vez
    async function loadAllEscolasIds() {
        try {
            loadingSpinner.classList.remove('d-none');
            const res = await fetch(escolasAllIdsUrl);
            const data = await res.json();
            allEscolasIds = new Set(data.ids.map(id => id.toString()));
            loadingSpinner.classList.add('d-none');
        } catch (err) {
            console.error('Erro ao carregar IDs de escolas:', err);
            loadingSpinner.classList.add('d-none');
        }
    }

    function updateCounter() {
        const count = escolasSelecionadas.size;
        counterEl.textContent = count
            ? `${count} escola(s) selecionada(s)`
            : 'Nenhuma escola selecionada';
    }

    // Selecionar todas as escolas (não apenas da página)
    selectAllBtn.addEventListener('click', async () => {
        // Se já tivermos carregado todos os IDs
        if (allEscolasIds.size > 0) {
            const allSelected = [...allEscolasIds].every(id => 
                escolasSelecionadas.has(id));
            
            if (allSelected) {
                allEscolasIds.forEach(id => escolasSelecionadas.delete(id));
            } else {
                allEscolasIds.forEach(id => escolasSelecionadas.add(id));
            }
            
            updateCounter();
            fetchEscolas(); // Recarrega a visualização
            return;
        }
        
        // Se ainda não carregamos os IDs, fazemos agora
        try {
            selectAllBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Carregando...';
            const res = await fetch(escolasAllIdsUrl);
            const data = await res.json();
            allEscolasIds = new Set(data.ids.map(id => id.toString()));
            
            const allSelected = [...allEscolasIds].every(id => 
                escolasSelecionadas.has(id));
            
            if (allSelected) {
                allEscolasIds.forEach(id => escolasSelecionadas.delete(id));
            } else {
                allEscolasIds.forEach(id => escolasSelecionadas.add(id));
            }
            
            updateCounter();
            fetchEscolas();
        } catch (err) {
            console.error('Erro ao selecionar todas as escolas:', err);
            alert('Erro ao carregar escolas. Tente novamente.');
        } finally {
            selectAllBtn.innerHTML = 'Selecionar Todas as Escolas';
        }
    });

    // Selecionar todas as escolas na página atual
    selectAllPageBtn.addEventListener('click', () => {
        const pageIds = lastFetchedSchools.map(s => s.id.toString());
        const allSelected = pageIds.every(id => escolasSelecionadas.has(id));
        
        if (allSelected) {
            pageIds.forEach(id => escolasSelecionadas.delete(id));
        } else {
            pageIds.forEach(id => escolasSelecionadas.add(id));
        }
        
        updateCounter();
        renderEscolas({ results: lastFetchedSchools });
    });

    async function fetchEscolas() {
        try {
            loadingSpinner.classList.remove('d-none');
            const q = encodeURIComponent(searchInput.value);
            const url = `${escolasApiUrl}?page=${currentPage}&search=${q}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            lastFetchedSchools = data.results;
            renderEscolas(data);
            loadingSpinner.classList.add('d-none');
        } catch (err) {
            console.error('Erro no fetchEscolas:', err);
            container.innerHTML = `
                <div class="col-12">
                  <div class="alert alert-danger">
                    Erro ao carregar escolas: ${err.message}
                  </div>
                </div>`;
            loadingSpinner.classList.add('d-none');
        }
    }

    function renderEscolas(data) {
        container.innerHTML = '';
        if (!data.results.length) {
            container.innerHTML = `
                <div class="col-12">
                  <div class="alert alert-warning">
                    Nenhuma escola encontrada com o filtro atual
                  </div>
                </div>`;
            return;
        }

        totalPages = Math.ceil(data.count / 10);
        pageLabel.textContent = `${currentPage}/${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;

        // Atualizar texto dos botões de seleção
        const pageIds = data.results.map(s => s.id.toString());
        const allPageSelected = pageIds.every(id => escolasSelecionadas.has(id));
        selectAllPageBtn.innerHTML = allPageSelected 
            ? 'Desselecionar Página' 
            : 'Selecionar Página';

        const allSelected = allEscolasIds.size > 0 && 
            [...allEscolasIds].every(id => escolasSelecionadas.has(id));
        selectAllBtn.innerHTML = allSelected 
            ? 'Desselecionar Todas' 
            : 'Selecionar Todas as Escolas';

        data.results.forEach(escola => {
            const idStr = escola.id.toString();
            const isSelected = escolasSelecionadas.has(idStr);
            const imgUrl = escola.foto_fachada_url || "{% static 'images/default-school.jpeg' %}";
            
            const card = document.createElement('div');
            card.className = 'col-md-6 mb-3';
            card.innerHTML = `
                <div class="card ${isSelected ? 'state-selected' : ''}" data-id="${escola.id}" style="cursor:pointer;">
                    <div class="row g-0">
                        <div class="col-md-4 position-relative">
                            <img src="${imgUrl}" class="img-fluid rounded-start" style="height:150px;object-fit:cover;">
                            <span class="badge-estado position-absolute top-0 start-0 m-2">
                                ${isSelected ? '✓ Vinculada' : '+ Vincular'}
                            </span>
                        </div>
                        <div class="col-md-8">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-1">${escola.nome}</h6>
                                <div class="small text-muted">
                                    <div><strong>INEP:</strong> ${escola.inep}</div>                                    
                                    <div class="mt-1"><i class="fas fa-user-tie me-1"></i>${escola.nome_gestor}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            const inner = card.querySelector('.card');
            inner.addEventListener('click', () => {
                const badge = inner.querySelector('.badge-estado');
                if (escolasSelecionadas.has(idStr)) {
                    escolasSelecionadas.delete(idStr);
                    inner.classList.remove('state-selected');
                    badge.textContent = '+ Vincular';
                } else {
                    escolasSelecionadas.add(idStr);
                    inner.classList.add('state-selected');
                    badge.textContent = '✓ Vinculada';
                }
                updateCounter();
                
                // Atualizar estado dos botões
                const allSelectedNow = allEscolasIds.size > 0 && 
                    [...allEscolasIds].every(id => escolasSelecionadas.has(id));
                selectAllBtn.innerHTML = allSelectedNow 
                    ? 'Desselecionar Todas' 
                    : 'Selecionar Todas as Escolas';
            });
            container.appendChild(card);
        });
    }

    // Paginação
    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) { 
            currentPage--; 
            fetchEscolas(); 
        }
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) { 
            currentPage++; 
            fetchEscolas(); 
        }
    });
    
    searchInput.addEventListener('input', () => {
        currentPage = 1;
        fetchEscolas();
    });

    // Salvar seleção
    saveBtn.addEventListener('click', () => {
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';
        saveBtn.disabled = true;
        
        fetch(assignUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                escolas: Array.from(escolasSelecionadas).map(id => parseInt(id, 10))
            })
        })
        .then(response => {
            if (response.ok) {
                // Feedback visual de sucesso
                saveBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Salvo!';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(modalEl).hide();
                    location.reload();
                }, 1500);
            } else {
                throw new Error('Erro ao salvar');
            }
        })
        .catch(error => {
            console.error('Erro ao salvar escolas:', error);
            saveBtn.innerHTML = 'Salvar';
            saveBtn.disabled = false;
            saveBtn.classList.add('btn-danger');
            setTimeout(() => {
                saveBtn.classList.remove('btn-danger');
            }, 3000);
            alert('Erro ao salvar escolas: ' + error.message);
        });
    });

    // Ao abrir modal
    modalEl.addEventListener('shown.bs.modal', async () => {
        const res = await fetch(assignUrl);
        const data = await res.json();
        escolasSelecionadas = new Set(data.assigned.map(id => id.toString()));
        updateCounter();
        await loadAllEscolasIds(); // Carrega todos os IDs
        fetchEscolas();
    });
});
</script>
{% endif %}
{% endblock %}