{% extends 'gestao_patrimonio/base.html' %}
{% load static %}

{% block title %}Gerenciar Bens{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Gerenciar Bens</h1>
    <div>
      <!-- Botão para adicionar novo bem -->
      <a href="{% url 'bem_form' %}" class="btn btn-success btn-sm me-2">
        <i class="bi bi-plus-circle"></i> Adicionar Novo Bem
      </a>
      <!-- Botão para abrir o modal de simulação RFID -->
      <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#rfidModal">
        <i class="bi bi-rss"></i> Simular RFID
      </button>
    </div>
  </div>

  <!-- Filtro de busca com select para escolha do campo -->
  <form method="GET" class="mb-4">
    <div class="row g-2">
      <div class="col-md-3">
        <select name="filter_by" class="form-select">
          <option value="all" {% if filter_by == "all" %}selected{% endif %}>Todos</option>
          <option value="id" {% if filter_by == "id" %}selected{% endif %}>ID</option>
          <option value="nome" {% if filter_by == "nome" %}selected{% endif %}>Nome</option>
          <option value="descricao" {% if filter_by == "descricao" %}selected{% endif %}>Descrição</option>
          <option value="categoria" {% if filter_by == "categoria" %}selected{% endif %}>Categoria</option>
          <option value="departamento" {% if filter_by == "departamento" %}selected{% endif %}>Departamento</option>
          <option value="fornecedor" {% if filter_by == "fornecedor" %}selected{% endif %}>Fornecedor</option>
        </select>
      </div>
      <div class="col-md-9">
        <div class="input-group">
          <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Pesquisar...">
          <button class="btn btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Buscar
          </button>
        </div>
      </div>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
            <thead class="table-light">
              <tr>
                <th class="small">ID</th>
                <th class="small">Nome</th>
                <th class="small">Descrição</th>
                <th class="small">Valor</th>
                <th class="small">Categoria</th>
                <th class="small">Departamento</th>
                <th class="small">Fornecedor</th>
                <th class="small">Nº Patrimônio</th>
                <th class="small">Data Aquisição</th>
                <th class="small">Status</th>
                <th class="small">RFID Tag</th>
                <th class="small">Ações</th>
            </tr>            
            </thead>
            <tbody>
                {% for bem in bens %}
                <tr>
                    <td>{{ bem.id }}</td>
                    <td>{{ bem.nome }}</td>
                    <td>{{ bem.descricao }}</td>
                    <td>R$ {{ bem.valor }}</td>
                    <td>{{ bem.categoria.nome }}</td>
                    <td>{{ bem.departamento.nome }}</td>
                    <td>{{ bem.fornecedor.nome|default:"-" }}</td>
                    <td>{{ bem.numero_patrimonio }}</td>
                    <td>{{ bem.data_aquisicao|date:"d/m/Y" }}</td>
                    <td>
                        <span class="badge {% if bem.status == 'ativo' %}bg-success{% elif bem.status == 'manutencao' %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ bem.get_status_display }}
                        </span>
                    </td>
                    <td>{{ bem.rfid_tag|default:"-" }}</td>
                    <td>
                        <a href="{% url 'editar_bem' bem.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-pencil-square"></i> Editar
                        </a>
                        <a href="#" class="btn btn-sm btn-danger" onclick="deleteBem({{ bem.id }}); return false;">
                            <i class="bi bi-trash"></i> Excluir
                        </a>
                        <a href="#" class="btn btn-sm btn-secondary" onclick="showHistorico({{ bem.id }}); return false;">
                          <i class="bi bi-clock-history"></i> Histórico
                        </a>
                        
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center">Nenhum bem cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  



    

      <!-- Paginação -->
      <nav>
        <ul class="pagination justify-content-center">
          {% if bens.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ bens.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}">Anterior</a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <span class="page-link">Anterior</span>
          </li>
          {% endif %}

          {% for num in bens.paginator.page_range %}
            {% if bens.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > bens.number|add:'-3' and num < bens.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}">{{ num }}</a>
            </li>
            {% endif %}
          {% endfor %}

          {% if bens.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ bens.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}">Próximo</a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <span class="page-link">Próximo</span>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Modal Histórico -->
<div class="modal fade" id="historicoModal" tabindex="-1" aria-labelledby="historicoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historicoModalLabel">Histórico do Bem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="historicoModalBody">        
      </div>
    </div>
  </div>
</div>

<!-- Modal para simulação RFID -->
<div class="modal fade" id="rfidModal" tabindex="-1" aria-labelledby="rfidModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rfidModalLabel"><i class="bi bi-rss"></i> Simular Leitura RFID</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <!-- Formulário para simular a leitura RFID -->
        <form id="rfidForm">
          <div class="mb-3">
            <label for="rfidInput" class="form-label">Tag RFID</label>
            <input type="text" class="form-control" id="rfidInput" placeholder="Digite a tag RFID">
            <!-- Área de sugestões -->
            <div id="suggestions" class="list-group mt-2"></div>
          </div>
          <div class="mb-3">
            <label for="destinoSelect" class="form-label">Destino (Departamento)</label>
            <select class="form-select" id="destinoSelect" name="destino">
              <option value="">Selecione um departamento</option>
              {% for dept in departamentos %}

              <option value="{{ dept.id }}">{{ dept.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-rss"></i> Simular Movimentação
          </button>
        </form>        
        <div id="result" class="mt-4"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static '/js/historico_modal.js' %}"></script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      let cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function deleteBem(bemId) {
    if (!window.confirm('Deseja realmente excluir este bem?')) {
        return false;
    }

    const csrftoken = getCookie('csrftoken');

    fetch(`/api/bens/excluir/${bemId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.status === 204) {
            // Se for 204 (No Content), não tenta fazer response.json()
            alert('Bem excluído com sucesso.');
            location.reload();
        } else {
            return response.json().then(data => {
                alert(data.message);
                location.reload();
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Houve um erro ao excluir o bem.');
    });

    return false;
}

</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const rfidInput = document.getElementById("rfidInput");
    const suggestionsDiv = document.getElementById("suggestions");

    let debounceTimeout = null;
    
    rfidInput.addEventListener("input", function () {
      const query = rfidInput.value.trim();
      if (debounceTimeout) clearTimeout(debounceTimeout);
      
      if (query.length < 2) {
        suggestionsDiv.innerHTML = "";
        return;
      }

      debounceTimeout = setTimeout(() => {
        fetch(`/api/buscar-tags-rfid/?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            suggestionsDiv.innerHTML = "";
            if (data.tags.length > 0) {
              data.tags.forEach(item => {
                const suggestionItem = document.createElement("a");
                suggestionItem.href = "#";
                suggestionItem.className = "list-group-item list-group-item-action";
                suggestionItem.textContent = item.rfid_tag;
                suggestionItem.setAttribute("data-bs-toggle", "popover");
                suggestionItem.setAttribute("data-bs-trigger", "hover");
                suggestionItem.setAttribute(
                  "data-bs-content",
                  `Nome: ${item.nome}<br>Descrição: ${item.descricao}<br>Patrimônio: ${item.numero_patrimonio} <br> Departamento: ${item.departamento__nome}`
                );

                suggestionItem.addEventListener("click", function (e) {
                  e.preventDefault();
                  rfidInput.value = item.rfid_tag;
                  suggestionsDiv.innerHTML = "";
                });

                suggestionsDiv.appendChild(suggestionItem);
              });

              // Ativa os popovers dinamicamente
              var popoverTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="popover"]')
              );
              popoverTriggerList.forEach(function (popoverTriggerEl) {
                new bootstrap.Popover(popoverTriggerEl, { html: true });
              });
            } else {
              const noResults = document.createElement("div");
              noResults.className = "list-group-item text-muted";
              noResults.textContent = "Nenhum RFID encontrado";
              suggestionsDiv.appendChild(noResults);
            }
          })
          .catch(error => {
            console.error("Erro ao buscar sugestões:", error);
          });
      }, 300);
    });

    document.addEventListener("click", function (event) {
      if (!rfidInput.contains(event.target) && !suggestionsDiv.contains(event.target)) {
        suggestionsDiv.innerHTML = "";
      }
    });

    // Evento de submissão do formulário
    document.getElementById("rfidForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const rfid = rfidInput.value.trim();
      const destino = document.getElementById("destinoSelect").value;
      
      if (!rfid) {
        alert("Informe uma tag RFID");
        return;
      }

      let url = `/api/simular_rfid/?rfid=${encodeURIComponent(rfid)}`;
      if (destino) url += `&destino=${encodeURIComponent(destino)}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById("result");
          resultDiv.innerHTML = `<div class="alert alert-${data.error ? "danger" : "success"}">${data.mensagem}</div>`;
          if (!data.error) {
        // Aguarda um curto período para o usuário ver a mensagem antes do reload
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }
        })
        .catch(error => {
          console.error("Erro ao simular RFID:", error);
          document.getElementById("result").innerHTML = `<div class="alert alert-danger">Ocorreu um erro na requisição.</div>`;
        });
    });
  });
</script>

{% endblock %}
