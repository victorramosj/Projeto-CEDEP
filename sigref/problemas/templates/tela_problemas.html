{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}
Problemas
{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="{% static 'css/tabelas.css' %}" />
<style>
.form-select {
    width: 160px;
}
table .form-select {
    color: #333; 
    padding: 5px 10px;      
    border-radius: 5px;       
    border: none;
    transition: background-color 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Problemas (<span id="problemas-count">{{ total_problemas }}</span>)</h3>

    <div class="col-12">
        <div class="d-flex justify-content-between gap-2 mb-3">
            
            <div class="input-group" style="width: 50%;">
                <input type="text" id="search-input" class="form-control" name="escola" value="{{ search_query }}" placeholder="Pesquise por Escola, Problema, Usuário...">
            </div>
            
            <div class="d-flex gap-2">
                <select class="form-select" id="date-filter" aria-label="Filtro Data">
                    <option value="">Data (Todas)</option>
                    <option value="1" {% if request.GET.data == '1' %}selected{% endif %}>Última semana</option>
                    <option value="2" {% if request.GET.data == '2' %}selected{% endif %}>Último mês</option>
                    <option value="3" {% if request.GET.data == '3' %}selected{% endif %}>Último ano</option>
                </select>
                <select class="form-select" id="status-filter" aria-label="Filtro Status">
                    <option value="">Status (Todos)</option>
                    <option value="P" {% if request.GET.status == 'P' %}selected{% endif %}>Pendente</option>
                    <option value="R" {% if request.GET.status == 'R' %}selected{% endif %}>Resolvido</option>
                    <option value="E" {% if request.GET.status == 'E' %}selected{% endif %}>Em Andamento</option>
                </select>
            </div>

            <div class="d-flex gap-2">
                <button class="btnAcao btn btn-info">Atualizar Status</button> 
                <button class="btnAcao btn btn-danger">Apagar Problemas</button> 
            </div>
        </div>

        <div id="problemas-table-wrapper">
            <table class="table table-striped mt-2">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox"></th>
                        <th class="text-start">Problema</th>
                        <th class="text-start">Escola</th>
                        <th class="text-start">Usuário</th>
                        <th class="text-start">Setor Responsável</th>
                        <th class="text-start">Data</th>
                        <th class="text-start">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for problema in problemas_page %}
                        <tr>
                            <td><input type="checkbox" class="problema-checkbox" name="problema_ids" value="{{ problema.id }}"></td>
                            <td class="text-start">{{ problema.descricao }}</td>
                            <td class="text-start">{{ problema.escola.nome }}</td>
                            <td class="text-start">{{ problema.usuario }}</td>
                            <td class="text-start">{{ problema.setor.hierarquia_completa }}</td>
                            <td class="text-start">{{ problema.criado_em|date:"d/m/Y" }}</td>
                            <td>
                                <select class="form-select" aria-label="Filtro Status" data-problema-id="{{ problema.id }}" 
                                    {% if problema.status == 'P' %} style="background-color: #ffcccc !important;" {% endif %} 
                                    {% if problema.status == 'R' %} style="background-color: #ccffcc !important;" {% endif %} 
                                    {% if problema.status == 'E' %} style="background-color: #ffffcc !important;" {% endif %}>
                                    <option value="P" {% if problema.status == 'P' %} selected {% endif %}>Pendente</option>
                                    <option value="R" {% if problema.status == 'R' %} selected {% endif %}>Resolvido</option>
                                    <option value="E" {% if problema.status == 'E' %} selected {% endif %}>Em Andamento</option>
                                </select>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center p-4">Nenhum problema encontrado.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if problemas_page.paginator.num_pages > 1 %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if problemas_page.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ problemas_page.previous_page_number }}&escola={{ search_query }}&data={{ request.GET.data }}&status={{ request.GET.status }}">Anterior</a></li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">Página {{ problemas_page.number }} de {{ problemas_page.paginator.num_pages }}</span></li>
                    {% if problemas_page.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ problemas_page.next_page_number }}&escola={{ search_query }}&data={{ request.GET.data }}&status={{ request.GET.status }}">Próximo</a></li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- LÓGICA DE FILTRAGEM DINÂMICA (FUNCIONAL) ---
    const searchInput = document.getElementById('search-input');
    const dateFilter = document.getElementById('date-filter');
    const statusFilter = document.getElementById('status-filter');
    const tableWrapper = document.getElementById('problemas-table-wrapper');
    const problemasCountSpan = document.getElementById('problemas-count');

    const fetchAndReplace = async () => {
        const query = searchInput.value;
        const date = dateFilter.value;
        const status = statusFilter.value;

        // Constrói a URL para a view com os parâmetros de filtro
        const url = `{% url 'tela_problema' %}?escola=${encodeURIComponent(query)}&data=${date}&status=${status}`;

        try {
            const response = await fetch(url);
            const textResponse = await response.text();
            
            // Converte o texto da resposta em um documento HTML temporário
            const parser = new DOMParser();
            const doc = parser.parseFromString(textResponse, 'text/html');

            // Encontra a nova tabela e o novo contador no documento temporário
            const newTableWrapper = doc.querySelector('#problemas-table-wrapper');
            const newCount = doc.querySelector('#problemas-count');

            // Substitui o conteúdo na página atual
            if (newTableWrapper) tableWrapper.innerHTML = newTableWrapper.innerHTML;
            if (newCount) problemasCountSpan.textContent = newCount.textContent;

        } catch (error) {
            console.error('Erro ao buscar problemas:', error);
        }
    };

    // Adiciona um delay na busca para não sobrecarregar o servidor
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(fetchAndReplace, 300);
    });

    // Adiciona os gatilhos para os filtros de data e status
    dateFilter.addEventListener('change', fetchAndReplace);
    statusFilter.addEventListener('change', fetchAndReplace);

    // --- LÓGICA PARA CHECKBOX "SELECIONAR TODOS" (ÚTIL PARA O FUTURO) ---
    document.body.addEventListener('change', function(event) {
        if (event.target.id === 'select-all-checkbox') {
            const checkboxes = document.querySelectorAll('.problema-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        }
    });
});
</script>

{% endblock %}