{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}{% endblock %}</title>

  <!-- Bootstrap CSS local -->
  <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" type="image/png" href="{% static 'images/CARD DA GRE.png' %}">
  <meta name="description" content="Sistema Integrado GRE Floresta Pernambuco - Gestão de hospedagens, eventos e recursos para a GRE Floresta.">
  <meta name="keywords" content="GRE Floresta, Pernambuco, Sistema Integrado, hospedagens, eventos, gestão, educação">
  <meta name="author" content="Gisele Novaes, João Victor Ramos, Lucas Bastos, Victor Kauê">
  
  <!-- Estilo adicional para responsividade e menu off-canvas -->
  <style>
    /* Estilo base da sidebar */
    #sidebar {
      width: 280px;
      min-width: 280px;
      min-height: 100vh;
      transition: margin-left 0.3s ease-in-out;
      z-index: 1040; /* Manter a sidebar acima do overlay */
    }

    #content-wrapper {
        width: 100%;
    }

    /* Scrollbar personalizada */
    #sidebar::-webkit-scrollbar {
      width: 8px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    /* Overlay para fechar o menu ao clicar fora */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1039; /* Abaixo da sidebar */
        cursor: pointer;
    }
    
    /* Botão de seta lateral (escondido por padrão em telas grandes) */
    #sidebarToggle {
        display: none;
    }


    /* Em telas pequenas (mobile) */
    @media (max-width: 768px) {
      /* Esconde a sidebar fora da tela por padrão */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        margin-left: -280px; /* Posição inicial (fechada) */
        overflow-y: auto;
      }
      
      /* Classe 'active' para mostrar a sidebar */
      #sidebar.active {
        margin-left: 0;
      }
      
      /* Mostra o overlay quando a sidebar está ativa */
      .sidebar-overlay.active {
          display: block;
      }
      
      /* Estilo da seta lateral (agora com position: fixed) */
      #sidebarToggle {
        display: flex; /* Mostra o botão em mobile */
        align-items: center;
        justify-content: center;
        position: fixed; /* Posição fixa na tela */
        top: 50%;
        left: 0; /* Posição inicial na borda da tela */
        transform: translateY(-50%);
        width: 30px; /* Menor */
        height: 55px; /* Menor */
        background-color: rgba(13, 110, 253, 0.7); /* Cor do tema com transparência */
        color: white;
        border: 1px solid rgba(0,0,0,0.1);
        border-left: none;
        border-radius: 0 8px 8px 0; /* Raio menor */
        font-size: 1rem; /* Menor */
        cursor: pointer;
        z-index: 1041; /* Z-index alto para ficar visível */
        transition: left 0.3s ease-in-out, background-color 0.2s;
      }
      
      /* Move a seta quando o menu está ativo */
      #sidebarToggle.active {
          left: 280px;
      }

      #sidebarToggle:hover {
        background-color: rgba(13, 110, 253, 0.9); /* Mais opaco no hover */
      }
    }
    
    /* Estilos do Rodapé (mantidos do original) */
    .compact-footer { padding: 0.8rem 0; border-top: 1px solid rgba(0, 0, 0, 0.1); background-color: rgba(255, 255, 255, 0.95); margin-top: 1rem; }
    .footer-content { display: flex; flex-direction: column; align-items: center; gap: 0.6rem; }
    .footer-text { color: #6c757d; font-size: 0.8rem; margin: 0 0.5rem; text-align: center; line-height: 1.2; }
    .footer-text .sigref { font-weight: 600; }
    .social-links { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center; }
    .social-link { color: #6c757d; font-size: 1.4rem; transition: color 0.2s ease, transform 0.2s ease; position: relative; }
    .social-link:hover { transform: translateY(-2px); text-decoration: none; }
    .social-link::after { content: attr(aria-label); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.85); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
    .social-link:hover::after { opacity: 1; }
    .bi-instagram:hover { color: #E1306C; }
    .bi-whatsapp:hover { color: #25d366; }
    .bi-info-circle:hover { color: rgb(229, 255, 0); }
    @media (max-width: 767px) {
      .footer-content { gap: 0.5rem; }
      .footer-text { font-size: 0.75rem; }
      .social-links { gap: 0.8rem; }
    }
  </style>

  {% block extra_style %}{% endblock %}
</head>

<body>
  
  <!-- Overlay para fechar o menu ao clicar fora -->
  <div class="sidebar-overlay"></div>

  <!-- Botão de seta lateral (agora fora da sidebar) -->
  <button class="btn" type="button" id="sidebarToggle" aria-label="Abrir ou fechar menu">
      <i class="fas fa-chevron-right"></i>
  </button>

  <div class="d-flex">
    <!-- Sidebar (agora com ID para o script) -->
    <div id="sidebar" class="sidebar d-flex flex-column flex-shrink-0 p-3 bg-cedepe text-white">
        
      <!-- O botão foi movido para fora -->
      
      <div class="logo-section">
        <div class="bg-white p-3 shadow-sm border border-success rounded-3 logo-container">
          <a href="{% if request.user.greuser.is_escola %}{% url 'escola_dashboard' %}{% else %}{% url 'home' %}{% endif %}" class="d-flex flex-column align-items-center text-dark text-decoration-none">
            <img src="{% static 'images/SIGREF.png' %}" alt="Logo GRE">
              <p class="p-2 mb-0 text-secondary small mt-2 " >

                Sistema Integrado <br /><strong class="gradiente-texto">GRE Floresta</strong>
              </p>
          </a>
        </div>
        <hr>
      </div>

      {% load static custom_tags %}

      <ul class="nav nav-pills flex-column mb-auto">
      <!-- Link para Início -->
      <li class="nav-item">
        <a href="{% if request.user.greuser.is_escola %}{% url 'escola_dashboard' %}{% else %}{% url 'home' %}{% endif %}" class="nav-link text-white sidebar-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
          <i class="fas fa-home me-2"></i>
          Início
        </a>
      {# --- Monitoramentos --- #}
      {% with current=request.resolver_match.url_name gre=user.greuser %}
      {% if user.is_authenticated and gre.is_monitor %}
        {# Usuários “monitores” veem apenas o link direto #}
        <li class="nav-item">
          <a href="{% url 'dashboard_monitoramentos' %}"
            class="nav-link text-white sidebar-link d-flex align-items-center {% if current == 'dashboard_monitoramentos' %}active{% endif %}">
            <i class="fas fa-chart-bar me-2"></i>Monitoramentos
          </a>
        </li>
      {% elif user.is_authenticated and gre.is_admin or gre.is_coordenador or gre.is_chefe_setor %}
        {# Admins, coordenadores e chefes de setor veem o dropdown completo #}
        <li class="nav-item">
          <a class="nav-link text-white sidebar-link d-flex justify-content-between align-items-center"
            data-bs-toggle="collapse"
            href="#monitoramentosSubmenu"
            role="button"
            aria-expanded="{{ current|url_in:'dashboard_monitoramentos,fluxo_monitoramento_setores,listar_avisos,tela_lacunas,tela_problemas,problemas-usuario-list'|yesno:'true,false' }}"
            aria-controls="monitoramentosSubmenu">
            <span><i class="fas fa-clipboard-list me-2"></i>Monitoramentos</span>
            <i class="fas fa-chevron-down"></i>
          </a>
          <ul class="nav flex-column ms-3 collapse {% if current|url_in:'dashboard_monitoramentos,fluxo_monitoramento_setores,listar_avisos,tela_lacunas,tela_problemas,problemas-usuario-list' %}show{% endif %}"
              id="monitoramentosSubmenu">

            <li>
              <a href="{% url 'dashboard_monitoramentos' %}"
                class="nav-link text-white sidebar-link {% if current == 'dashboard_monitoramentos' %}active{% endif %}">
                <i class="fas fa-chart-bar me-2"></i>Visão Geral
              </a>
            </li>
            <li>
              <a href="{% url 'fluxo_monitoramento_setores' %}"
                class="nav-link text-white sidebar-link {% if current == 'fluxo_monitoramento_setores' %}active{% endif %}">
                <i class="fas fa-tasks me-2"></i>Fluxo por Setores
              </a>
            </li>
            {% if request.user.is_superuser or request.user.greuser.setor.nome|upper == 'CGAF' or request.user.greuser.setor.nome|upper == 'UDP' or request.user.greuser.setor.nome|upper == 'ADMINISTRADOR' %}
                <li>
                  <a href="{% url 'tela_lacunas' %}"
                    class="nav-link text-white sidebar-link {% if current == 'tela_lacunas' %}active{% endif %}">
                    <i class="fas fa-book me-2"></i>Lacunas
                  </a>
                </li>
            {% endif %}
            
            <li>
              <a href="{% url 'tela_problemas' %}"
                class="nav-link text-white sidebar-link {% if current == 'tela_problemas' %}active{% endif %}">
                <i class="fas fa-exclamation-circle me-2"></i>Problemas
              </a>
            </li>
            <li>
              <a href="{% url 'listar_avisos' %}"
                class="nav-link text-white sidebar-link {% if current == 'listar_avisos' %}active{% endif %}">
                <i class="fas fa-exclamation-triangle me-2"></i>Avisos
              </a>
            </li>
          </ul>
        </li>
      {% endif %}


      {% if user.is_staff and not user.greuser.is_monitor %}
        {# Questionários #}
        <li class="nav-item mt-2">
          <a class="nav-link text-white sidebar-link d-flex justify-content-between align-items-center"
            data-bs-toggle="collapse"
            href="#questionariosSubmenu"
            role="button"
            aria-expanded="{{ current|url_in:'gerenciar_questionarios,criar-questionario'|yesno:'true,false' }}"
            aria-controls="questionariosSubmenu">
            <span><i class="fas fa-file-alt me-2"></i>Questionários</span>
            <i class="fas fa-chevron-down"></i>
          </a>
          <ul class="nav flex-column ms-3 collapse {% if current|url_in:'gerenciar_questionarios,criar-questionario' %}show{% endif %}"
              id="questionariosSubmenu">
            <li>
              <a href="{% url 'gerenciar_questionarios' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_questionarios' %}active{% endif %}">
                <i class="fas fa-list me-2"></i>Gerenciar Questionários
              </a>
            </li>
            <li>
              
            </li>
          </ul>
        </li>
      {% endif %}

      {% endwith %}
        
      
      {% if user.is_authenticated and user.is_superuser or user.greuser.is_admin or user.greuser.tipo_usuario == 'CEDEPE' %}

        {# Mostrar opções de hospedagem #}
        {% with current=request.resolver_match.url_name %}
          <li class="nav-item">
            <a class="nav-link text-white sidebar-link d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse"
              href="#hospedagensSubmenu"
              role="button"
              aria-expanded="{{ current|url_in:'dashboard_hospedagens,mapa_interativo,gerenciar_reservas,gerenciar_ocupacoes,gerenciar_quartos,gerenciar_camas,gerenciar_hospedes'|yesno:'true,false' }}"
              aria-controls="hospedagensSubmenu">
              <span><i class="fas fa-hotel me-2"></i>Hospedagens</span>
              <i class="fas fa-chevron-down"></i>
            </a>
            <ul class="nav flex-column ms-3 collapse {% if current|url_in:'dashboard_hospedagens,mapa_interativo,gerenciar_reservas,gerenciar_ocupacoes,gerenciar_quartos,gerenciar_camas,gerenciar_hospedes' %}show{% endif %}"
                id="hospedagensSubmenu">
              <li>
                <a href="{% url 'dashboard_hospedagens' %}"
                  class="nav-link text-white sidebar-link {% if current == 'dashboard_hospedagens' %}active{% endif %}">
                  <i class="fas fa-chart-line me-2"></i>Dashboard Hospedagens
                </a>
              </li>
              <li>
                <a href="{% url 'mapa_interativo' %}"
                  class="nav-link text-white sidebar-link {% if current == 'mapa_interativo' %}active{% endif %}">
                  <i class="fas fa-map me-2"></i>Mapa dos quartos
                </a>
              </li>
              <li>
                <a href="{% url 'gerenciar_reservas' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_reservas' %}active{% endif %}">
                  <i class="fas fa-calendar-check me-2"></i>Reservas
                </a>
              </li>
              <li>
                <a href="{% url 'gerenciar_ocupacoes' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_ocupacoes' %}active{% endif %}">
                  <i class="fas fa-calendar-alt me-2"></i>Ocupações
                </a>
              </li>
              <li>
                <a href="{% url 'gerenciar_quartos' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_quartos' %}active{% endif %}">
                  <i class="fas fa-door-open me-2"></i>Quartos
                </a>
              </li>
              <li>
                <a href="{% url 'gerenciar_camas' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_camas' %}active{% endif %}">
                  <i class="fas fa-bed me-2"></i>Camas
                </a>
              </li>
              <li>
                <a href="{% url 'gerenciar_hospedes' %}"
                  class="nav-link text-white sidebar-link {% if current == 'gerenciar_hospedes' %}active{% endif %}">
                  <i class="fas fa-users me-2"></i>Hóspedes
                </a>
              </li>
              
            </ul>
          </li>
        {% endwith %}
        {% endif %} 
        {% with current=request.resolver_match.url_name %} 
      {% if user.is_authenticated and user.greuser.is_cedepes or user.is_superuser or user.greuser.is_admin %}
        <li class="nav-item">
          <a class="nav-link text-white sidebar-link d-flex justify-content-between align-items-center"
            data-bs-toggle="collapse"
            href="#eventosSubmenu"
            role="button"
            aria-expanded="{{ current|url_in:'dashboard_eventos,gerenciar_eventos,gerenciar_agendamentos,gerenciar_salas'|yesno:'true,false' }}"
            aria-controls="eventosSubmenu">
            <span><i class="fas fa-calendar-alt me-2"></i>Eventos</span>
            <i class="fas fa-chevron-down"></i>
          </a>
          <ul class="nav flex-column ms-3 collapse {% if current|url_in:'dashboard_eventos,gerenciar_eventos,gerenciar_agendamentos,gerenciar_salas' %}show{% endif %}"
              id="eventosSubmenu">
            <li>
              <a href="{% url 'dashboard_eventos' %}"
                class="nav-link text-white sidebar-link {% if current == 'dashboard_eventos' %}active{% endif %}">
                <i class="fas fa-chart-line me-2"></i>Painel de Eventos
              </a>
            </li>
            <li>
              <a href="{% url 'gerenciar_eventos' %}"
                class="nav-link text-white sidebar-link {% if current == 'gerenciar_eventos' %}active{% endif %}">
                <i class="fas fa-calendar me-2"></i>Gerenciar Eventos
              </a>
            </li>
            <li>
              <a href="{% url 'gerenciar_agendamentos' %}"
                class="nav-link text-white sidebar-link {% if current == 'gerenciar_agendamentos' %}active{% endif %}">
                <i class="fas fa-clock me-2"></i>Agendamentos
              </a>
            </li>
            <li>
              <a href="{% url 'gerenciar_salas' %}"
                class="nav-link text-white sidebar-link {% if current == 'gerenciar_salas' %}active{% endif %}">
                <i class="bi bi-house-door me-2"></i>Salas
              </a>
            </li>
            <li class="nav-item">
          
          </ul>
        </li>
        

      {% else %}
        <li class="nav-item">
          <a href="{% url 'dashboard_eventos' %}"
            class="nav-link text-white sidebar-link d-flex align-items-center {% if current == 'dashboard_eventos' %}active{% endif %}">
            <i class="fas fa-calendar-alt me-2"></i>Eventos
          </a>
        </li>
      {% endif %}
      {% endwith %}


        
        {% if user.is_authenticated and user.is_staff or user.is_superuser %}
        {# --- Central de controle --- #}
        <li class="nav-item">
          <a href="/admin" class="nav-link text-white sidebar-link {% if request.path == '/admin/' %}active{% endif %}">
            <i class="fas fa-tools me-2"></i>Central de controle
          </a>
        </li>
        {% if user.is_superuser %}
            <li class="nav-item">
                <a class="nav-link text-warning" href="{% url 'lista_validacoes_pendentes' %}">
                    <i class="fas fa-check-double"></i> Validações Pendentes
                </a>
            </li>
        {% endif %}
        {% endif %}
</ul>

      </ul>
        
      <div class="mt-auto"> <!-- User info and logout at the bottom -->
        {% if user.is_authenticated %}
        <div class="text-center mb-3">
          <i class="fas fa-user-circle me-2"></i>
          <strong>{{ gre_user.nome_completo }}</strong>
        </div>
        <a href="{% url 'logout' %}" class="btn btn-danger w-100">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
        {% else %}
        <div class="d-grid gap-2">
          <a href="{% url 'login' %}" class="btn btn-outline-light">
            <i class="fas fa-sign-in-alt me-2"></i>Login
          </a>          
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="content-wrapper" class="flex-grow-1 d-flex flex-column overflow-auto">
      
      <main class="flex-grow-1 container-fluid" style="background: radial-gradient(circle, #ffffff 0%, #cce7ff 100%);">
        {% block content %}{% endblock %}
      </main>
      
      <footer class="bg-body-tertiary text-dark py-4 border-top border-primary mt-auto">
        <div class="container">
          <div class="row w-100 g-4 align-items-center">
            
            <div class="col-12 col-md-3 d-flex justify-content-center justify-content-md-start">
              <div class="gre-logo-footer-container">
                <img src="{% static 'images/CARD DA GRE.png' %}" alt="GRE Floresta" class="img-fluid" style="max-width:110px; height:auto;">
              </div>
            </div>

            <div class="col-12 col-md-6 text-center">
              <p class="mb-1">
                Sistema Integrado Gerência Regional de Educação de Floresta.
              </p>
              <small class="text-muted">
                &copy; {% now "Y" %} <span class="fw-bold">SIGREF</span> - Todos os direitos reservados.
              </small>
            </div>

            <div class="col-12 col-md-3 d-flex flex-column align-items-center align-items-md-end">
              
              <h5 class="fw-semibold mb-2">Conecte-se</h5>
              
              <div class="d-flex gap-3"> 
                <a href="https://www.instagram.com/grefloresta.oficial/" target="_blank" class="link-dark" aria-label="Visite nosso Instagram" title="Instagram"> 
                  <i class="bi bi-instagram fs-4"></i>
                </a>
          
                <a href="https://wa.me/558791019828?text=..." target="_blank" class="link-dark" aria-label="Fale conosco via WhatsApp" title="WhatsApp">  
                  <i class="bi bi-whatsapp fs-4"></i>
                </a>
          
                <a href="{% url 'sobre' %}" target="_blank" class="link-dark" aria-label="Conheça mais sobre nós" title="Sobre o sistema"> 
                  <i class="bi bi-info-circle fs-4"></i>
                </a>
              </div>
            </div>

          </div>
        </div>
      </footer>
    </div>
  </div>

  <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Script para controlar o menu off-canvas -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        const toggleIcon = sidebarToggle.querySelector('i');

        const toggleSidebar = () => {
            // Ativa/desativa as classes da sidebar, overlay e do próprio botão
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
            sidebarToggle.classList.toggle('active');

            // Troca o ícone da seta
            if (sidebar.classList.contains('active')) {
                // Se o menu está aberto, a seta aponta para a esquerda
                toggleIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
            } else {
                // Se o menu está fechado, a seta aponta para a direita
                toggleIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
            }
        };

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
        }

        if (sidebarOverlay) {
            // Adiciona o evento para fechar ao clicar no overlay
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }
    });
  </script>

  {% block scripts %}{% endblock scripts %}
  {% block extra_script %}{% endblock extra_script %}

</body>
</html>
