{% extends 'gestao_patrimonio/base.html' %}
{% load static %}

{% block title %}Novo Bem{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-lg border-0 bg-light">
    <div class="card-header bg-light border-bottom py-3 d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0 text-dark">
        <i class="bi bi-box-seam me-2"></i>Cadastro de Bem Patrimonial
      </h2>
      <!-- Botão para voltar para Gerenciar Bens -->
      <a href="{% url 'gerenciar_bens' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Voltar
      </a>
    </div>
    
    <div class="card-body p-4">
      <form id="bemForm" class="row g-4" method="POST">
        {% csrf_token %}
        <!-- Seção 1: Dados Gerais -->
        <div class="col-12">
          <h5 class="text-muted mb-3">
            <i class="bi bi-info-circle me-2"></i>Dados Gerais
          </h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label for="nome" class="form-label small fw-bold">Nome do Bem</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-tag"></i></span>
                <input type="text" name="nome" id="nome" class="form-control" required>
              </div>
            </div>
            <div class="col-md-3">
              <label for="valor" class="form-label small fw-bold">Valor (R$)</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                <input type="number" name="valor" id="valor" class="form-control" step="0.01" required value="{{ bem.valor|floatformat:2 }}">
                
              </div>
            </div>
            <div class="col-md-3">
              <label for="rfid_tag" class="form-label small fw-bold">Etiqueta RFID</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                <input type="text" name="rfid_tag" id="rfid_tag" class="form-control">
              </div>
            </div>
            <div class="col-md-3">
              <label for="data_aquisicao" class="form-label small fw-bold">Aquisição</label>
              <input type="date" name="data_aquisicao" id="data_aquisicao" class="form-control form-control-sm" required>
            </div>
            <!-- Seção 3: patrimonio descricao e status -->
            <div class="row g-3">
              <div class="col-md-2">
                <label for="numero_patrimonio" class="form-label small fw-bold">Tombamento</label>
                <input type="text" name="numero_patrimonio" id="numero_patrimonio" class="form-control form-control-sm"
                  required value="{{ bem.numero_patrimonio }}">
              </div>
              <div class="col-md-3">
                <label for="status" class="form-label small fw-bold">Status</label>
                <select name="status" id="status" class="form-select form-select-sm" required>
                  <option value="ativo" {% if bem.status == 'ativo' %}selected{% endif %}>Ativo</option>
                  <option value="manutencao" {% if bem.status == 'manutencao' %}selected{% endif %}>Manutenção</option>
                  <option value="descartado" {% if bem.status == 'descartado' %}selected{% endif %}>Descartado</option>
                </select>
              </div>
              <div class="col-md-7">
                <label for="descricao" class="form-label small fw-bold"> <i class="bi bi-chat-left-text me-2"></i>Descrição</label>
                <textarea name="descricao" id="descricao" class="form-control form-control-sm"
                  rows="2">{{ bem.descricao }}</textarea>
              </div>
            </div>
            </div>
        <!-- Seção 3: Classificação -->
        <div class="col-12">
          <h5 class="text-muted mb-3">
            <i class="bi bi-diagram-3 me-2"></i>Classificação
          </h5>
          <div class="row g-3">
            <div class="col-md-4">
              <label for="categoria" class="form-label small fw-bold">Categoria</label>
              <div class="input-group input-group-sm">
                <select name="categoria" id="categoria" class="form-select" required>
                  <option value="" disabled selected>-- Selecione --</option>
                  {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#categoriaModal">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <label for="departamento" class="form-label small fw-bold">Departamento</label>
              <div class="input-group input-group-sm">
                <select name="departamento" id="departamento" class="form-select" required>
                  <option value="" disabled selected>-- Selecione --</option>
                  {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.nome }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#departamentoModal">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <label for="fornecedor" class="form-label small fw-bold">Fornecedor</label>
              <div class="input-group input-group-sm">
                <select name="fornecedor" id="fornecedor" class="form-select" required>
                  <option value="" disabled selected>-- Selecione --</option>
                  {% for sup in suppliers %}
                    <option value="{{ sup.id }}">{{ sup.nome }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#fornecedorModal">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Botão de Submissão -->  
        <div class="col-12 text-end mt-4">
          <button type="submit" class="btn btn-success btn-sm">
            <i class="bi bi-save me-2"></i>Salvar Bem
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
  
<!-- Inclusão dos modais -->
{% include 'core/modals/categoria_modal.html' %}
{% include 'core/modals/departamento_modal.html' %}
{% include 'core/modals/fornecedor_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function setupModalForm(formId, url, selectId) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            let formData = new FormData(form);
            let data = {};
            formData.forEach((value, key) => { data[key] = value });

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    alert('Criado com sucesso!');
                    if (selectId) {
                        const select = document.getElementById(selectId);
                        if (select) {
                            let option = new Option(result.nome, result.id);
                            select.add(option);
                        }
                    }
                    let modalElement = document.getElementById(formId.replace('Form', 'Modal'));
                    if (modalElement) {
                        let modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                        modalInstance.hide();
                    }
                    form.reset();
                } else {
                    let errorMessage = result.error || 'Erro ao criar.';
                    if (result.errors) {
                        errorMessage += "\n" + JSON.stringify(result.errors, null, 2);
                    }
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Erro:', error);

                let errorMessage = 'Erro ao processar a solicitação.';

                if (typeof error === 'object' && error !== null) {
                    if (error.errors) {
                        errorMessage += '\n\nDetalhes:\n';
                        for (const [campo, mensagens] of Object.entries(error.errors)) {
                            errorMessage += `- ${campo}: ${mensagens.join(', ')}\n`;
                        }
                    } else if (error.detail) {
                        errorMessage += `\n\nDetalhe: ${error.detail}`;
                    }
                } else {
                    errorMessage += '\n\nErro inesperado.';
                }

                // Exibe o erro no alert
                alert(errorMessage);
            });
        });
    }

    setupModalForm('categoriaForm', '/api/criar_categoria/', 'categoria');
    setupModalForm('departamentoForm', '/api/criar_departamento/', 'departamento');
    setupModalForm('fornecedorForm', '/api/criar_fornecedor/', 'fornecedor');
    setupModalForm('bemForm', '/api/bens/novo/', 'bens');
});

  </script>
  

{% endblock %}
