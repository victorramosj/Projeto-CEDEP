{% extends 'cedepe/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Gerenciar Questionários</h2>
  <table class="table table-hover mt-3">
    <thead>
      <tr>
        <th>#</th>
        <th>Título</th>
        <th>Descrição</th>
        <th>Data</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for q in questionarios %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ q.titulo }}</td>
        <td>{{ q.descricao|truncatechars:50 }}</td>
        <td>{{ q.data_criacao }}</td>
        <td>
          <a href="{% url 'gerenciar_perguntas' q.id %}" class="btn btn-sm btn-primary">
            Perguntas
          </a>
          <button class="btn btn-sm btn-secondary" onclick="abrirModalEscolas({{ q.id }})">
            Escolas
          </button>
          
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Nenhum questionário encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'criar-questionario' %}" class="btn btn-success">
    + Novo Questionário
  </a>
</div>
  <!-- Modal para Adicionar Escolas -->
  <div class="modal fade" id="assignSchoolsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Escolas ao Questionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <input type="text" id="search-escolas" class="form-control form-control-sm w-75"
                        placeholder="Buscar por nome, INEP, endereço ou email...">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" id="prev-page">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3" id="current-page">1</span>
                        <button class="btn btn-sm btn-outline-secondary" id="next-page">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="escolas-counter" class="mb-2 text-muted small"></div>
                <div id="escolas-container" class="row g-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="saveSchoolsBtn" class="btn btn-primary btn-sm">Salvar</button>
            </div>
        </div>
    </div>
</div>
</div>
{% block scripts %}
{% if questionario_selecionado %}
<script>
    (function () {
        const modalEl = document.getElementById('assignSchoolsModal');
        const assignUrl = "{% url 'assign_escolas' questionario_selecionado.id %}";
        const escolasApiUrl = "{% url 'escolas-list' %}";
        let escolasSelecionadas = new Set();
        let currentPage = 1;
        let totalPages = 1;

        const container = modalEl.querySelector('#escolas-container');
        const searchInput = modalEl.querySelector('#search-escolas');
        const counterEl = modalEl.querySelector('#escolas-counter');

        function updateCounter() {
            const count = escolasSelecionadas.size;
            counterEl.textContent = count ? `${count} escola(s) selecionada(s)` : '';
        }

        function fetchEscolas() {
            const query = searchInput.value;
            const url = `${escolasApiUrl}?page=${currentPage}&search=${encodeURIComponent(query)}`;
            fetch(url)
                .then(res => res.json())
                .then(data => renderEscolas(data));
        }

        function renderEscolas(data) {
            totalPages = Math.ceil(data.count / 10);
            document.getElementById('current-page').textContent = `Página ${currentPage} de ${totalPages}`;

            if (!data.results.length) {
                container.innerHTML = '<p class="text-center text-muted w-100">Nenhuma escola encontrada.</p>';
                return;
            }

            container.innerHTML = '';
            data.results.forEach(escola => {
                const isSelected = escolasSelecionadas.has(escola.id.toString());
                const card = document.createElement('div');
                card.className = 'col-md-6';

                const imageUrl = escola.foto_fachada_url || "{% static 'img/default-school.png' %}";

                card.innerHTML = `
                    <div class="card escola-card ${isSelected ? 'border-primary' : ''}" data-id="${escola.id}">
                        <div class="row g-0">
                            <div class="col-md-4">
                                <img src="${imageUrl}" class="img-fluid rounded-start" style="height: 150px; object-fit: cover;">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <h6 class="card-title mb-1">${escola.nome}</h6>
                                    <p class="mb-1 small text-muted">INEP: ${escola.inep}</p>
                                    <p class="mb-0 small">${escola.endereco || ''}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                card.querySelector('.card').addEventListener('click', function () {
                    const escolaId = escola.id.toString();
                    if (escolasSelecionadas.has(escolaId)) {
                        escolasSelecionadas.delete(escolaId);
                        this.classList.remove('border-primary');
                    } else {
                        escolasSelecionadas.add(escolaId);
                        this.classList.add('border-primary');
                    }
                    updateCounter();
                });

                container.appendChild(card);
            });

            updateCounter();
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchEscolas();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchEscolas();
            }
        });

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            fetchEscolas();
        });

        document.getElementById('saveSchoolsBtn').addEventListener('click', () => {
            fetch(assignUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ escolas: Array.from(escolasSelecionadas) })
            })
                .then(res => {
                    if (res.ok) {
                        location.reload();
                    } else {
                        alert('Erro ao salvar as escolas selecionadas.');
                    }
                })
                .catch(err => {
                    console.error('Erro ao enviar:', err);
                    alert('Erro na requisição.');
                });
        });

        modalEl.addEventListener('shown.bs.modal', fetchEscolas);
    })();
</script>
{% endif %}
{% endblock %}