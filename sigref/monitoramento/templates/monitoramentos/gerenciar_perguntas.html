{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}Perguntas do Questionário: {{ questionario.titulo }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-2 fw-bold" style="color: #10295d">
      <i class="bi bi-question-circle me-2"></i>
      Perguntas de “{{ questionario.titulo }}”
    </h1>
    <div class="btn-group">
      <a href="{% url 'fluxo_monitoramento_setores' %}" class="btn btn-outline-secondary btn-sm me-2">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
      <button class="btn btn-success btn-sm" id="btn-add">
        <i class="bi bi-plus-circle"></i> Nova Pergunta
      </button>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle table-bordered mb-0" id="questions-table">
          <thead class="table-primary">
            <tr>
              <th style="width: 80px;">Ordem</th>
              <th>Texto</th>
              <th style="width: 120px;">Tipo</th>
              <th style="width: 120px;">Ações</th>
            </tr>
          </thead>
          <tbody style="background-color: #f8fafc;"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de cadastro/edição -->
<div class="modal fade" id="questionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Pergunta</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="question-form">
          {% csrf_token %}
          <input type="hidden" id="question-id">
          <input type="hidden" id="questionario-id" value="{{ questionario.pk }}">
          <div class="mb-3">
            <label class="form-label fw-semibold">Texto</label>
            <textarea class="form-control" id="question-text" rows="2" required placeholder="Digite o texto da pergunta"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Ordem</label>
            <input type="number" class="form-control" id="question-order" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Tipo</label>
            <select class="form-select" id="question-type">
              <option value="SN">Sim/Não</option>
              <option value="NU">Numérico</option>
              <option value="TX">Texto</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer bg-light">
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary btn-sm" id="btn-save">
          <i class="bi bi-save me-1"></i>Salvar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (function () {
    const apiBase = '{{ perguntas_api_url }}'.replace(/\/$/, '');
    const modalEl = document.getElementById('questionModal');
    const modal = new bootstrap.Modal(modalEl);
    const tableBody = document.querySelector('#questions-table tbody');

    document.getElementById('btn-add').onclick = () => openModal();
    document.getElementById('btn-save').onclick = saveQuestion;

    loadQuestions();

    async function loadQuestions() {
      try {
        const res = await fetch(apiBase);
        const data = await res.json();
        tableBody.innerHTML = '';
        (data.results || data).forEach(q => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center fw-bold">${q.ordem}</td>
            <td>${q.texto}</td>
            <td class="text-center">
              <span class="badge ${
                q.tipo_resposta === 'SN' ? 'bg-info text-dark' :
                q.tipo_resposta === 'NU' ? 'bg-warning text-dark' :
                'bg-secondary'
              }">
                ${ { SN:'Sim/Não', NU:'Numérico', TX:'Texto' }[q.tipo_resposta] || q.tipo_resposta }
              </span>
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-warning me-1" onclick="openModal(${q.id})" title="Editar">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})" title="Excluir">
                <i class="bi bi-trash"></i>
              </button>
            </td>`;
          tableBody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        alert('Erro ao carregar perguntas.');
      }
    }

    window.openModal = async function(id) {
      document.getElementById('question-form').reset();
      document.getElementById('question-id').value = '';
      if (id) {
        const res = await fetch(`${apiBase}/${id}/`);
        const q = await res.json();
        document.getElementById('question-id').value = q.id;
        document.getElementById('question-text').value = q.texto;
        document.getElementById('question-order').value = q.ordem;
        document.getElementById('question-type').value = q.tipo_resposta;
      } else {
        const res = await fetch(`${apiBase}/?ordering=-ordem&page_size=1`);
        const last = (await res.json()).results?.[0];
        document.getElementById('question-order').value = last ? last.ordem + 1 : 1;
      }
      modal.show();
    };

    async function saveQuestion() {
      const id = document.getElementById('question-id').value;
      const payload = {
        texto: document.getElementById('question-text').value,
        ordem: +document.getElementById('question-order').value,
        tipo_resposta: document.getElementById('question-type').value,
        questionario: +document.getElementById('questionario-id').value
      };
      const url = id ? `${apiBase}/${id}/` : `${apiBase}/`;
      const method = id ? 'PUT' : 'POST';
      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Falha ao salvar');
        modal.hide();
        loadQuestions();
      } catch (e) {
        console.error(e);
        alert(e.message);
      }
    }

    window.deleteQuestion = async function(id) {
      if (!confirm('Confirma exclusão?')) return;
      try {
        const res = await fetch(`${apiBase}/${id}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        if (!res.ok) throw new Error();
        loadQuestions();
      } catch {
        alert('Erro ao excluir pergunta.');
      }
    };
  })();
</script>
{% endblock %}
