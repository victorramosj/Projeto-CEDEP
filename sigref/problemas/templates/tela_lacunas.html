{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}
Lacunas
{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="{% static 'css/lacunas.css' %}" />
{% endblock %}


{% block content %}
<div class="container mt-4">
    <h3>Lacunas ({{ lacunas_total }})</h3>

    <div class="col-12">
        <div class="d-flex justify-content-between gap-2">
            <!-- Barra de pesquisa -->
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Pesquise por Escola ou Disciplina...">
            </div>
            
            <div class="d-flex gap-2">
                <!-- Filtros -->
                <select class="form-select" aria-label="Filtro Data">
                    <option selected>Data</option>
                    <option value="1">Última semana</option>
                    <option value="2">Último mês</option>
                    <option value="3">Último ano</option>
                </select>
                <select class="form-select" aria-label="Filtro Status">
                    <option selected>Status</option>
                    <option value="1">Resolvido</option>
                    <option value="2">Em Andamento</option>
                    <option value="3">Pendente</option>
                </select>
            </div>

            <div class="d-flex gap-2">
                <!-- Botões de ação -->
                <button class="btnAcao btn btn-info">Atualizar Status</button> 
                <button class="btnAcao btn btn-danger">Apagar Lacunas</button> 
            </div>
        </div>

        <!-- Tabela de Lacunas -->
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th><input type="checkbox"></th>
                    <th class="text-start">Escola</th>
                    <th class="text-start">Disciplina</th>
                    <th class="text-start">Carga H.</th>
                    <th class="text-start">Data</th>
                    <th class="text-start">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for lacuna in lacunas_page %}
                    <tr>
                        <td><input type="checkbox"></td>
                        <td class="text-start">{{ lacuna.escola.nome }}</td>
                        <td class="text-start">{{ lacuna.disciplina }}</td>
                        <td class="text-start">{{ lacuna.carga_horaria }}</td>
                        <td class="text-start">{{ lacuna.criado_em|date:"d/m/Y" }}</td>
                        <td>
                            <select class="form-select" aria-label="Filtro Status" data-lacuna-id="{{ lacuna.id }}">
                                <option value="P" {% if lacuna.status == 'P' %} selected {% endif %}>Pendente</option>
                                <option value="R" {% if lacuna.status == 'R' %} selected {% endif %}>Resolvido</option>
                                <option value="E" {% if lacuna.status == 'E' %} selected {% endif %}>Em Andamento</option>
                            </select>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginação -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if lacunas_page.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1">&laquo; Primeiro</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ lacunas_page.previous_page_number }}">Anterior</a></li>
            {% endif %}
            {% for num in lacunas_page.paginator.page_range %}
                {% if lacunas_page.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}
            {% if lacunas_page.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ lacunas_page.next_page_number }}">Próximo</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ lacunas_page.paginator.num_pages }}">Último &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const selects = document.querySelectorAll('select[name="status"]');

        selects.forEach(select => {
            select.addEventListener('change', function() {
                const lacunaId = this.getAttribute('data-lacuna-id');
                const newStatus = this.value;

                fetch(`/lacuna/${lacunaId}/alterar_status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({ 'status': newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        alert('Status atualizado com sucesso!');
                    } else {
                        alert('Erro ao atualizar o status!');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao atualizar o status!');
                });
            });
        });
    });
</script>

{% endblock %}