{% extends "cedepe/base.html" %}
{% load static %}

{% block title %}Detalhes das Lacunas{% endblock %}

{% block extra_style %}
<style>
    /* Estilos para os cards de lacuna (reutilizados da tela de problemas) */
    .lacuna-card {
        background-color: #fff;
        border: 1px solid #eef2f7;
        border-left-width: 5px;
        border-radius: var(--border-radius-md);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .lacuna-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        cursor: pointer;
    }

    /* Cores das bordas baseadas no status */
    .lacuna-card[data-status="P"] { border-left-color: var(--red); }
    .lacuna-card[data-status="E"] { border-left-color: var(--orange); }
    .lacuna-card[data-status="R"] { border-left-color: var(--green); }

    .lacuna-card .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.4em 0.8em;
    }

    /* Estilo para o estado vazio */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background-color: #fff;
        border-radius: var(--border-radius-lg);
        border: 2px dashed #e0e0e0;
    }
    .empty-state .icon {
        font-size: 3rem;
        color: #ced4da;
    }
    .empty-state p {
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Estilos para a nova barra de pesquisa */
    .search-container .input-group {
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        transition: box-shadow 0.3s ease-in-out;
    }
    .search-container .input-group:focus-within {
        box-shadow: 0 6px 25px rgba(38, 50, 109, 0.1);
    }
    .search-container .form-control, 
    .search-container .input-group-text {
        border: none;
        background-color: #fff;
        height: 50px;
    }
    .search-container .form-control:focus {
        box-shadow: none;
    }
    .search-container .input-group-text {
        padding-left: 1.25rem;
        color: var(--text-muted);
    }

    /* Ajustes de responsividade */
    @media (max-width: 991.98px) {
        .lacuna-info-grid {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    @media (max-width: 575.98px) {
        .lacuna-info-grid {
            grid-template-columns: 1fr !important;
            gap: 0.5rem !important;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="container my-4 my-md-5">

    <!-- ================================================================== -->
    <!--                      Cabeçalho e Filtros                           -->
    <!-- ================================================================== -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
        <h1 class="titulo-secao mb-0" style="border-color: var(--primary-color);">
            <i class="fas fa-puzzle-piece text-primary me-2"></i>Histórico de Lacunas
        </h1>
        <a href="{% url 'dashboard_escola' escola_id=escola.id %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
        </a>
    </div>

    <!-- Barra de Pesquisa (NOVO LAYOUT) -->
    <div class="search-container mb-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar por disciplina...">
        </div>
    </div>

    <!-- ================================================================== -->
    <!--                      Lista de Lacunas (Cards)                      -->
    <!-- ================================================================== -->
    <div class="vstack gap-3" id="lacunas-list">
        {% for lacuna in lacunas %}
            <div class="lacuna-card p-3" 
                 data-status="{{ lacuna.status }}" 
                 data-search-text="{{ lacuna.disciplina|lower }}"
                 data-bs-toggle="modal" 
                 data-bs-target="#modalDetalheLacuna"
                 data-lacuna-id="{{ lacuna.id }}"
                 data-lacuna-disciplina="{{ lacuna.disciplina }}"
                 data-lacuna-carga="{{ lacuna.carga_horaria }}"
                 data-lacuna-data="{{ lacuna.criado_em|date:'d/m/Y H:i' }}"
                 data-lacuna-status="{{ lacuna.status }}">

                <h6 class="mb-1">
                    <strong class="text-dark">Lacuna:</strong>
                    <span class="fw-bold text-muted">{{ lacuna.disciplina }}</span>
                </h6>
                
                <hr class="my-2">

                <!-- Detalhes Rápidos -->
                <div class="d-grid gap-3 lacuna-info-grid" style="grid-template-columns: repeat(3, 1fr); font-size: 0.85rem;">
                    
                    <div class="text-muted"><i class="fas fa-clock me-2 text-primary"></i><strong>Carga:</strong> {{ lacuna.carga_horaria }} horas/aula</div>
                    <div class="text-muted"><i class="fas fa-calendar-alt me-2 text-primary"></i><strong>Data:</strong> {{ lacuna.criado_em|date:"d/m/Y H:i" }}</div>
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2 text-primary"></i><strong>Status:</strong>
                        {% if lacuna.status == 'R' %}<span class="badge rounded-pill status-badge bg-success">{{ lacuna.get_status_display }}</span>
                        {% elif lacuna.status == 'P' %}<span class="badge rounded-pill status-badge bg-danger">{{ lacuna.get_status_display }}</span>
                        {% elif lacuna.status == 'E' %}<span class="badge rounded-pill status-badge bg-warning text-dark">{{ lacuna.get_status_display }}</span>
                        {% else %}<span class="badge rounded-pill status-badge bg-secondary">{{ lacuna.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            {# Este bloco será mostrado pelo JavaScript se a lista estiver vazia #}
        {% endfor %}
    </div>

    <!-- Mensagem de Estado Vazio (controlada por JS) -->
    <div id="empty-state-message" class="empty-state d-none mt-4">
        <div class="icon"><i class="fas fa-search"></i></div>
        <h5 class="mt-3">Nenhuma Lacuna Encontrada</h5>
        <p>Tente ajustar os filtros ou o termo de busca.</p>
    </div>

    <!-- ================================================================== -->
    <!--                          Paginação                                 -->
    <!-- ================================================================== -->
    {% if lacunas.has_other_pages %}
    <nav aria-label="Paginação de lacunas" class="mt-4 d-flex justify-content-center">
        <ul class="pagination">
            {% if lacunas.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ lacunas.previous_page_number }}">Anterior</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            
            {% for i in lacunas.paginator.page_range %}
                {% if lacunas.number == i %}
                    <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}
            
            {% if lacunas.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ lacunas.next_page_number }}">Próxima</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Próxima</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- ================================================================== -->
<!--                    Modal de Detalhes da Lacuna                     -->
<!-- ================================================================== -->
<div class="modal fade" id="modalDetalheLacuna" tabindex="-1" aria-labelledby="modalDetalheLacunaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetalheLacunaLabel">Detalhes da Lacuna</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <h6 id="modal-lacuna-disciplina" class="mb-3"></h6>
                <p><strong>Carga Horária:</strong> <span id="modal-lacuna-carga"></span> horas/aula</p>
                <p><strong>Data de Criação:</strong> <span id="modal-lacuna-data"></span></p>
                <hr>
                
                <!-- Formulário para alterar o status -->
                <form id="form-alterar-status-lacuna" method="POST">
                    {% csrf_token %}
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label for="select-status-lacuna" class="form-label"><strong>Alterar Status</strong></label>
                            <select id="select-status-lacuna" name="status" class="form-select">
                                <option value="P">Pendente</option>
                                <option value="E">Em Andamento</option>
                                <option value="R">Resolvida</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success w-100">Salvar Status</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DE FILTRO E BUSCA (ATUALIZADA) ---
    const searchInput = document.getElementById('searchInput');
    const lacunasList = document.getElementById('lacunas-list');
    const allLacunas = lacunasList.querySelectorAll('.lacuna-card');
    const emptyStateMessage = document.getElementById('empty-state-message');

    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        let visibleCount = 0;

        allLacunas.forEach(card => {
            const cardText = card.dataset.searchText;
            
            if (cardText.includes(searchTerm)) {
                card.classList.remove('d-none');
                visibleCount++;
            } else {
                card.classList.add('d-none');
            }
        });

        if (visibleCount === 0) {
            emptyStateMessage.classList.remove('d-none');
        } else {
            emptyStateMessage.classList.add('d-none');
        }
    }

    searchInput.addEventListener('keyup', filterAndSearch);

    if (allLacunas.length === 0) {
        emptyStateMessage.querySelector('p').textContent = 'Ótimo! Nenhuma lacuna foi reportada para esta escola.';
        emptyStateMessage.querySelector('.icon').innerHTML = '<i class="fas fa-check-circle"></i>';
        emptyStateMessage.classList.remove('d-none');
    }

    // --- LÓGICA DO MODAL ---
    const modalDetalheLacuna = document.getElementById('modalDetalheLacuna');
    if (modalDetalheLacuna) {
        modalDetalheLacuna.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const lacunaId = button.dataset.lacunaId;
            const disciplina = button.dataset.lacunaDisciplina;
            const carga = button.dataset.lacunaCarga;
            const data = button.dataset.lacunaData;
            const status = button.dataset.lacunaStatus;

            const modal = this;
            modal.querySelector('#modal-lacuna-disciplina').textContent = disciplina;
            modal.querySelector('#modal-lacuna-carga').textContent = carga;
            modal.querySelector('#modal-lacuna-data').textContent = data;
            modal.querySelector('#select-status-lacuna').value = status;
            
            const form = modal.querySelector('#form-alterar-status-lacuna');
            form.action = `/problemas/lacunas/alterar-status/${lacunaId}/`;
        });
    }
});
</script>
{% endblock %}
